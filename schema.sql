-- Generated by src/scripts/generateSchemaSql.js

-- Paste into your Postgres/Supabase SQL editor

CREATE EXTENSION IF NOT EXISTS postgis;

CREATE EXTENSION IF NOT EXISTS pgcrypto;

DO 'BEGIN CREATE TYPE "public"."enum_users_role" AS ENUM(''client'', ''driver'', ''restaurant'', ''admin'', ''cashier''); EXCEPTION WHEN duplicate_object THEN null; END';

CREATE TABLE IF NOT EXISTS "users" ("id" UUID NOT NULL  , "email" VARCHAR(255) NOT NULL UNIQUE , "password" VARCHAR(255) NOT NULL , "role" "public"."enum_users_role" NOT NULL , "is_active" BOOLEAN NOT NULL DEFAULT true , "last_login" TIMESTAMP WITH TIME ZONE , "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id")); COMMENT ON COLUMN "users"."id" IS 'Primary key (UUID)'; COMMENT ON COLUMN "users"."email" IS 'User''s email (unique)'; COMMENT ON COLUMN "users"."password" IS 'Hashed password'; COMMENT ON COLUMN "users"."role" IS 'User role type'; COMMENT ON COLUMN "users"."is_active" IS 'Account active status'; COMMENT ON COLUMN "users"."last_login" IS 'Last login timestamp';

DO 'BEGIN CREATE TYPE "public"."enum_restaurants_status" AS ENUM(''pending'', ''approved'', ''suspended'', ''archived''); EXCEPTION WHEN duplicate_object THEN null; END';

CREATE TABLE IF NOT EXISTS "restaurants" ("id" UUID NOT NULL  , "user_id" UUID NOT NULL UNIQUE REFERENCES "users" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "name" VARCHAR(255) NOT NULL, "description" TEXT, "address" TEXT, "phone_number" VARCHAR(255) , "email" VARCHAR(255) , "location" GEOGRAPHY(POINT,4326) NOT NULL, "rating" DECIMAL(2,1) DEFAULT 0 , "image_url" VARCHAR(255) , "is_active" BOOLEAN NOT NULL DEFAULT true , "is_premium" BOOLEAN NOT NULL DEFAULT false , "status" "public"."enum_restaurants_status" DEFAULT 'pending', "opening_hours" JSON , "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id")); COMMENT ON COLUMN "restaurants"."id" IS 'Primary key (UUID)'; COMMENT ON COLUMN "restaurants"."user_id" IS 'Reference to user account'; COMMENT ON COLUMN "restaurants"."phone_number" IS 'Restaurant contact phone number'; COMMENT ON COLUMN "restaurants"."email" IS 'Restaurant contact email'; COMMENT ON COLUMN "restaurants"."rating" IS 'Note sur 5 étoiles'; COMMENT ON COLUMN "restaurants"."image_url" IS 'URL de l''image principale du restaurant'; COMMENT ON COLUMN "restaurants"."is_active" IS 'Restaurant actif ou non'; COMMENT ON COLUMN "restaurants"."is_premium" IS 'Restaurant premium ou non'; COMMENT ON COLUMN "restaurants"."opening_hours" IS 'Opening hours per day, e.g.: { Mon: {open: 9:00 a.m., close: 6:00 p.m.}, Tue: {...} }';

CREATE TABLE IF NOT EXISTS "food_categories" ("id" UUID NOT NULL  , "restaurant_id" UUID NOT NULL REFERENCES "restaurants" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "nom" VARCHAR(255) NOT NULL , "description" TEXT , "icone_url" VARCHAR(255) , "ordre_affichage" INTEGER , "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id")); COMMENT ON COLUMN "food_categories"."id" IS 'Primary key (UUID)'; COMMENT ON COLUMN "food_categories"."restaurant_id" IS 'Foreign key to restaurant'; COMMENT ON COLUMN "food_categories"."nom" IS 'Category name'; COMMENT ON COLUMN "food_categories"."description" IS 'Detailed description of the food category'; COMMENT ON COLUMN "food_categories"."icone_url" IS 'Icon image URL representing the category'; COMMENT ON COLUMN "food_categories"."ordre_affichage" IS 'Display order for sorting categories';

CREATE TABLE IF NOT EXISTS "menu_items" ("id" UUID , "restaurant_id" UUID NOT NULL REFERENCES "restaurants" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "category_id" UUID NOT NULL REFERENCES "food_categories" ("id") ON DELETE SET NULL ON UPDATE CASCADE, "nom" VARCHAR(255) NOT NULL, "description" TEXT, "prix" DECIMAL(10,2) NOT NULL, "photo_url" VARCHAR(255), "is_available" BOOLEAN DEFAULT true, "temps_preparation" INTEGER DEFAULT 20, "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id"));

CREATE TABLE IF NOT EXISTS "additions" ("id" UUID , "menu_item_id" UUID NOT NULL REFERENCES "menu_items" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "nom" VARCHAR(255) NOT NULL, "description" TEXT, "prix" DECIMAL(10,2) NOT NULL, "is_available" BOOLEAN DEFAULT true, "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id"));

DO 'BEGIN CREATE TYPE "public"."enum_clients_status" AS ENUM(''active'', ''suspended'', ''deleted''); EXCEPTION WHEN duplicate_object THEN null; END';

CREATE TABLE IF NOT EXISTS "clients" ("id" UUID NOT NULL  , "user_id" UUID NOT NULL UNIQUE REFERENCES "users" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "first_name" VARCHAR(100) NOT NULL , "last_name" VARCHAR(100) NOT NULL , "email" VARCHAR(255) NOT NULL UNIQUE , "phone_number" VARCHAR(20) , "address" TEXT , "location" GEOGRAPHY(POINT,4326) , "profile_image_url" VARCHAR(255) , "loyalty_points" INTEGER NOT NULL DEFAULT 0 , "is_verified" BOOLEAN DEFAULT false , "is_active" BOOLEAN NOT NULL DEFAULT true , "status" "public"."enum_clients_status" DEFAULT 'active' , "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id")); COMMENT ON COLUMN "clients"."id" IS 'Unique client identifier (UUID)'; COMMENT ON COLUMN "clients"."user_id" IS 'Reference to user account'; COMMENT ON COLUMN "clients"."first_name" IS 'Client''s first name'; COMMENT ON COLUMN "clients"."last_name" IS 'Client''s last name'; COMMENT ON COLUMN "clients"."email" IS 'Client''s email (must be unique)'; COMMENT ON COLUMN "clients"."phone_number" IS 'Client''s phone number'; COMMENT ON COLUMN "clients"."address" IS 'Primary address of the client'; COMMENT ON COLUMN "clients"."location" IS 'Geographical coordinates of the client''s address'; COMMENT ON COLUMN "clients"."profile_image_url" IS 'Client''s profile picture URL'; COMMENT ON COLUMN "clients"."loyalty_points" IS 'Loyalty points earned by the client'; COMMENT ON COLUMN "clients"."is_verified" IS 'Indicates whether the client''s email/phone is verified'; COMMENT ON COLUMN "clients"."is_active" IS 'Indicates whether the client''s account is active'; COMMENT ON COLUMN "clients"."status" IS 'Current status of the client''s account';

DO 'BEGIN CREATE TYPE "public"."enum_cashiers_status" AS ENUM(''active'', ''on_break'', ''offline'', ''suspended''); EXCEPTION WHEN duplicate_object THEN null; END';

CREATE TABLE IF NOT EXISTS "cashiers" ("id" UUID NOT NULL  , "user_id" UUID NOT NULL UNIQUE REFERENCES "users" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "restaurant_id" UUID NOT NULL REFERENCES "restaurants" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "cashier_code" VARCHAR(255) NOT NULL UNIQUE , "first_name" VARCHAR(255) NOT NULL , "last_name" VARCHAR(255) NOT NULL , "phone" VARCHAR(255) NOT NULL , "email" VARCHAR(255) , "profile_image_url" VARCHAR(255) , "is_active" BOOLEAN NOT NULL DEFAULT true , "status" "public"."enum_cashiers_status" NOT NULL DEFAULT 'offline' , "shift_start" TIMESTAMP WITH TIME ZONE , "shift_end" TIMESTAMP WITH TIME ZONE , "total_orders_processed" INTEGER NOT NULL DEFAULT 0 , "total_sales_amount" DECIMAL(10,2) NOT NULL DEFAULT 0 , "last_active_at" TIMESTAMP WITH TIME ZONE , "notes" TEXT , "permissions" JSONB DEFAULT '{"can_create_orders":true,"can_cancel_orders":false,"can_apply_discounts":false,"can_process_refunds":false,"can_view_reports":false}' , "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id")); COMMENT ON COLUMN "cashiers"."id" IS 'Primary key (UUID)'; COMMENT ON COLUMN "cashiers"."user_id" IS 'Reference to user account'; COMMENT ON COLUMN "cashiers"."restaurant_id" IS 'Restaurant où travaille le caissier'; COMMENT ON COLUMN "cashiers"."cashier_code" IS 'Unique cashier code (e.g., CSH-0001)'; COMMENT ON COLUMN "cashiers"."first_name" IS 'Cashier''s first name'; COMMENT ON COLUMN "cashiers"."last_name" IS 'Cashier''s last name'; COMMENT ON COLUMN "cashiers"."phone" IS 'Cashier''s phone number'; COMMENT ON COLUMN "cashiers"."email" IS 'Cashier''s email'; COMMENT ON COLUMN "cashiers"."profile_image_url" IS 'Cashier''s profile picture URL'; COMMENT ON COLUMN "cashiers"."is_active" IS 'Cashier account active status'; COMMENT ON COLUMN "cashiers"."status" IS 'Current cashier status'; COMMENT ON COLUMN "cashiers"."shift_start" IS 'Current shift start time'; COMMENT ON COLUMN "cashiers"."shift_end" IS 'Current shift end time'; COMMENT ON COLUMN "cashiers"."total_orders_processed" IS 'Total number of orders processed'; COMMENT ON COLUMN "cashiers"."total_sales_amount" IS 'Total sales amount processed'; COMMENT ON COLUMN "cashiers"."last_active_at" IS 'Last time cashier was active'; COMMENT ON COLUMN "cashiers"."notes" IS 'Admin notes about cashier'; COMMENT ON COLUMN "cashiers"."permissions" IS 'Cashier permissions';

DO 'BEGIN CREATE TYPE "public"."enum_drivers_vehicle_type" AS ENUM(''motorcycle'', ''bicycle'', ''scooter''); EXCEPTION WHEN duplicate_object THEN null; END';

DO 'BEGIN CREATE TYPE "public"."enum_drivers_status" AS ENUM(''available'', ''busy'', ''offline'', ''suspended''); EXCEPTION WHEN duplicate_object THEN null; END';

CREATE TABLE IF NOT EXISTS "drivers" ("id" UUID NOT NULL  , "user_id" UUID NOT NULL UNIQUE REFERENCES "users" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "driver_code" VARCHAR(255) NOT NULL UNIQUE , "first_name" VARCHAR(255) NOT NULL , "last_name" VARCHAR(255) NOT NULL , "phone" VARCHAR(255) NOT NULL UNIQUE , "email" VARCHAR(255) , "vehicle_type" "public"."enum_drivers_vehicle_type" NOT NULL , "vehicle_plate" VARCHAR(255) , "license_number" VARCHAR(255) , "status" "public"."enum_drivers_status" NOT NULL DEFAULT 'offline' , "current_location" GEOGRAPHY(POINT,4326) , "rating" DECIMAL(2,1) DEFAULT 5 , "total_deliveries" INTEGER NOT NULL DEFAULT 0 , "active_orders" UUID[] NOT NULL DEFAULT ARRAY[]::UUID[] , "max_orders_capacity" INTEGER NOT NULL DEFAULT 5 , "is_verified" BOOLEAN NOT NULL DEFAULT false , "is_active" BOOLEAN NOT NULL DEFAULT true , "last_active_at" TIMESTAMP WITH TIME ZONE , "notes" TEXT , "cancellation_count" INTEGER NOT NULL DEFAULT 0 , "profile_image_url" VARCHAR(255) , "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id")); COMMENT ON COLUMN "drivers"."id" IS 'Primary key (UUID)'; COMMENT ON COLUMN "drivers"."user_id" IS 'Reference to user account'; COMMENT ON COLUMN "drivers"."driver_code" IS 'Unique driver code (e.g., DRV-0001)'; COMMENT ON COLUMN "drivers"."first_name" IS 'Driver''s first name'; COMMENT ON COLUMN "drivers"."last_name" IS 'Driver''s last name'; COMMENT ON COLUMN "drivers"."phone" IS 'Driver''s phone number'; COMMENT ON COLUMN "drivers"."email" IS 'Driver''s email'; COMMENT ON COLUMN "drivers"."vehicle_type" IS 'Type of vehicle'; COMMENT ON COLUMN "drivers"."vehicle_plate" IS 'Vehicle plate number'; COMMENT ON COLUMN "drivers"."license_number" IS 'Driver''s license number'; COMMENT ON COLUMN "drivers"."status" IS 'Current driver status'; COMMENT ON COLUMN "drivers"."current_location" IS 'Current GPS coordinates'; COMMENT ON COLUMN "drivers"."rating" IS 'Average rating (1-5 stars)'; COMMENT ON COLUMN "drivers"."total_deliveries" IS 'Total number of completed deliveries'; COMMENT ON COLUMN "drivers"."active_orders" IS 'Array of active order IDs (multiple deliveries)'; COMMENT ON COLUMN "drivers"."max_orders_capacity" IS 'Maximum number of orders this driver can handle simultaneously'; COMMENT ON COLUMN "drivers"."is_verified" IS 'Driver verification status'; COMMENT ON COLUMN "drivers"."is_active" IS 'Driver account active status'; COMMENT ON COLUMN "drivers"."last_active_at" IS 'Last time driver was active'; COMMENT ON COLUMN "drivers"."notes" IS 'Admin notes about driver'; COMMENT ON COLUMN "drivers"."cancellation_count" IS 'Number of order cancellations by driver'; COMMENT ON COLUMN "drivers"."profile_image_url" IS 'Client''s profile picture URL';

DO 'BEGIN CREATE TYPE "public"."enum_orders_order_type" AS ENUM(''delivery'', ''pickup''); EXCEPTION WHEN duplicate_object THEN null; END';

DO 'BEGIN CREATE TYPE "public"."enum_orders_status" AS ENUM(''pending'', ''accepted'', ''preparing'', ''assigned'', ''arrived'', ''delivering'', ''delivered'', ''declined''); EXCEPTION WHEN duplicate_object THEN null; END';

DO 'BEGIN CREATE TYPE "public"."enum_orders_payment_method" AS ENUM(''baridi_mob'', ''cash_on_delivery'', ''bank_transfer''); EXCEPTION WHEN duplicate_object THEN null; END';

CREATE TABLE IF NOT EXISTS "orders" ("id" UUID , "preparation_time" INTEGER , "order_number" VARCHAR(255) UNIQUE, "client_id" UUID REFERENCES "clients" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "created_by_cashier_id" UUID REFERENCES "cashiers" ("id") ON DELETE SET NULL ON UPDATE CASCADE, "restaurant_id" UUID NOT NULL REFERENCES "restaurants" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "order_type" "public"."enum_orders_order_type" DEFAULT 'delivery', "delivery_address" TEXT, "delivery_location" GEOGRAPHY(POINT,4326), "status" "public"."enum_orders_status" DEFAULT 'pending', "payment_method" "public"."enum_orders_payment_method", "subtotal" DECIMAL(10,2) NOT NULL DEFAULT 0, "delivery_fee" DECIMAL(10,2) DEFAULT 0, "delivery_distance" DECIMAL(10,2) , "total_amount" DECIMAL(10,2), "delivery_instructions" TEXT, "estimated_delivery_time" TIMESTAMP WITH TIME ZONE, "livreur_id" UUID REFERENCES "drivers" ("id") ON DELETE NO ACTION ON UPDATE CASCADE, "accepted_at" TIMESTAMP WITH TIME ZONE, "preparing_started_at" TIMESTAMP WITH TIME ZONE, "assigned_at" TIMESTAMP WITH TIME ZONE, "delivering_started_at" TIMESTAMP WITH TIME ZONE, "delivered_at" TIMESTAMP WITH TIME ZONE, "rating" DECIMAL(2,1) , "driver_rating" DECIMAL(2,1) , "review_comment" VIRTUAL, "driver_review_comment" TEXT , "decline_reason" TEXT, "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id")); COMMENT ON COLUMN "orders"."preparation_time" IS 'Estimated time in minutes for restaurant to prepare the order'; COMMENT ON COLUMN "orders"."delivery_distance" IS 'Distance in kilometers between restaurant and delivery location'; COMMENT ON COLUMN "orders"."rating" IS 'Restaurant rating (1-5)'; COMMENT ON COLUMN "orders"."driver_rating" IS 'Driver rating (1-5)'; COMMENT ON COLUMN "orders"."driver_review_comment" IS 'Optional comment provided for the driver rating';

CREATE TABLE IF NOT EXISTS "order_items" ("id" UUID , "order_id" UUID NOT NULL REFERENCES "orders" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "menu_item_id" UUID NOT NULL REFERENCES "menu_items" ("id") ON DELETE RESTRICT ON UPDATE CASCADE, "quantite" INTEGER NOT NULL DEFAULT 1, "prix_unitaire" DECIMAL(10,2) NOT NULL, "prix_total" DECIMAL(10,2), "instructions_speciales" TEXT, "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id"));

CREATE TABLE IF NOT EXISTS "order_item_additions" ("id" UUID , "order_item_id" UUID NOT NULL REFERENCES "order_items" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "addition_id" UUID NOT NULL REFERENCES "additions" ("id") ON DELETE NO ACTION ON UPDATE CASCADE, "quantite" INTEGER NOT NULL DEFAULT 1, "prix_unitaire" DECIMAL(10,2) NOT NULL, "prix_total" DECIMAL(10,2) NOT NULL, "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id"));

CREATE TABLE IF NOT EXISTS "favorite_meals" ("id" UUID NOT NULL  , "client_id" UUID NOT NULL REFERENCES "clients" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "meal_id" UUID NOT NULL REFERENCES "menu_items" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "customizations" TEXT , "notes" TEXT , "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, UNIQUE ("client_id", "meal_id"), PRIMARY KEY ("id")); COMMENT ON COLUMN "favorite_meals"."id" IS 'Unique favorite meal identifier (UUID)'; COMMENT ON COLUMN "favorite_meals"."client_id" IS 'Reference to the client who favorited the meal'; COMMENT ON COLUMN "favorite_meals"."meal_id" IS 'Reference to the favorited meal'; COMMENT ON COLUMN "favorite_meals"."customizations" IS 'Custom preferences or modifications for the meal'; COMMENT ON COLUMN "favorite_meals"."notes" IS 'Personal notes about the meal';

CREATE TABLE IF NOT EXISTS "favorite_restaurants" ("id" UUID NOT NULL  , "client_id" UUID NOT NULL REFERENCES "clients" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "restaurant_id" UUID NOT NULL REFERENCES "restaurants" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "notes" TEXT , "tags" VARCHAR(255)[] DEFAULT ARRAY[]::VARCHAR(255)[] , "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, UNIQUE ("client_id", "restaurant_id"), PRIMARY KEY ("id")); COMMENT ON COLUMN "favorite_restaurants"."id" IS 'Unique favorite restaurant identifier (UUID)'; COMMENT ON COLUMN "favorite_restaurants"."client_id" IS 'Reference to the client who favorited the restaurant'; COMMENT ON COLUMN "favorite_restaurants"."restaurant_id" IS 'Reference to the favorited restaurant'; COMMENT ON COLUMN "favorite_restaurants"."notes" IS 'Personal notes about the restaurant'; COMMENT ON COLUMN "favorite_restaurants"."tags" IS 'Custom tags for organizing favorites';

CREATE TABLE IF NOT EXISTS "FavoriteAddresses" ("id" UUID , "client_id" UUID NOT NULL REFERENCES "clients" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "name" VARCHAR(255) NOT NULL , "address" TEXT NOT NULL, "location" GEOGRAPHY(POINT,4326), "lat" DECIMAL(10,7) NOT NULL, "lng" DECIMAL(10,7) NOT NULL, "is_default" BOOLEAN DEFAULT false, "createdAt" TIMESTAMP WITH TIME ZONE NOT NULL, "updatedAt" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id")); COMMENT ON COLUMN "FavoriteAddresses"."name" IS 'Nom court: Domicile, Bureau, etc.';

DO 'BEGIN CREATE TYPE "public"."enum_admins_role_level" AS ENUM(''super_admin'', ''admin'', ''moderator''); EXCEPTION WHEN duplicate_object THEN null; END';

CREATE TABLE IF NOT EXISTS "admins" ("id" UUID NOT NULL  , "user_id" UUID NOT NULL UNIQUE REFERENCES "users" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "first_name" VARCHAR(255) NOT NULL , "last_name" VARCHAR(255) NOT NULL , "phone" VARCHAR(255) , "email" VARCHAR(255) NOT NULL , "role_level" "public"."enum_admins_role_level" NOT NULL DEFAULT 'admin' , "is_active" BOOLEAN NOT NULL DEFAULT true , "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id")); COMMENT ON COLUMN "admins"."id" IS 'Primary key (UUID)'; COMMENT ON COLUMN "admins"."user_id" IS 'Reference to user account'; COMMENT ON COLUMN "admins"."first_name" IS 'Admin''s first name'; COMMENT ON COLUMN "admins"."last_name" IS 'Admin''s last name'; COMMENT ON COLUMN "admins"."phone" IS 'Admin''s phone number'; COMMENT ON COLUMN "admins"."email" IS 'Admin''s email'; COMMENT ON COLUMN "admins"."role_level" IS 'Admin access level'; COMMENT ON COLUMN "admins"."is_active" IS 'Admin account active status';

DO 'BEGIN CREATE TYPE "public"."enum_admin_notifications_type" AS ENUM(''pending_order_timeout'', ''restaurant_unresponsive'', ''driver_unresponsive'', ''driver_excessive_cancellations''); EXCEPTION WHEN duplicate_object THEN null; END';

DO 'BEGIN CREATE TYPE "public"."enum_admin_notifications_admin_action" AS ENUM(''force_accept'', ''cancel_order'', ''contacted_restaurant'', ''none''); EXCEPTION WHEN duplicate_object THEN null; END';

CREATE TABLE IF NOT EXISTS "admin_notifications" ("id" UUID NOT NULL  , "order_id" UUID REFERENCES "orders" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "restaurant_id" UUID REFERENCES "restaurants" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "type" "public"."enum_admin_notifications_type" NOT NULL DEFAULT 'pending_order_timeout' , "message" TEXT NOT NULL , "order_details" JSON , "restaurant_info" JSON , "is_read" BOOLEAN NOT NULL DEFAULT false , "is_resolved" BOOLEAN NOT NULL DEFAULT false , "resolved_by" UUID REFERENCES "admins" ("id") ON DELETE SET NULL ON UPDATE CASCADE , "resolved_at" TIMESTAMP WITH TIME ZONE , "admin_action" "public"."enum_admin_notifications_admin_action" , "admin_notes" TEXT , "driver_id" UUID REFERENCES "drivers" ("id") ON DELETE SET NULL ON UPDATE CASCADE , "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id")); COMMENT ON COLUMN "admin_notifications"."id" IS 'Primary key (UUID)'; COMMENT ON COLUMN "admin_notifications"."order_id" IS 'Reference to the order'; COMMENT ON COLUMN "admin_notifications"."restaurant_id" IS 'Reference to the restaurant'; COMMENT ON COLUMN "admin_notifications"."type" IS 'Type of notification'; COMMENT ON COLUMN "admin_notifications"."message" IS 'Notification message'; COMMENT ON COLUMN "admin_notifications"."order_details" IS 'Complete order information'; COMMENT ON COLUMN "admin_notifications"."restaurant_info" IS 'Restaurant contact info'; COMMENT ON COLUMN "admin_notifications"."is_read" IS 'Has admin read this notification'; COMMENT ON COLUMN "admin_notifications"."is_resolved" IS 'Has admin handled this notification'; COMMENT ON COLUMN "admin_notifications"."resolved_by" IS 'Admin who resolved this'; COMMENT ON COLUMN "admin_notifications"."resolved_at" IS 'When was this resolved'; COMMENT ON COLUMN "admin_notifications"."admin_action" IS 'Action taken by admin'; COMMENT ON COLUMN "admin_notifications"."admin_notes" IS 'Admin''s notes about the resolution'; COMMENT ON COLUMN "admin_notifications"."driver_id" IS 'Driver involved in the notification';

CREATE TABLE IF NOT EXISTS "system_configs" ("id" UUID NOT NULL  , "config_key" VARCHAR(255) NOT NULL UNIQUE , "config_value" JSONB NOT NULL , "description" TEXT , "updated_by" UUID REFERENCES "admins" ("id") ON DELETE SET NULL ON UPDATE CASCADE , "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id")); COMMENT ON COLUMN "system_configs"."id" IS 'Primary key (UUID)'; COMMENT ON COLUMN "system_configs"."config_key" IS 'Configuration key (e.g., ''max_orders_per_driver'')'; COMMENT ON COLUMN "system_configs"."config_value" IS 'Configuration value (can be any JSON)'; COMMENT ON COLUMN "system_configs"."description" IS 'Description of the configuration'; COMMENT ON COLUMN "system_configs"."updated_by" IS 'Admin who last updated this config';

CREATE TABLE IF NOT EXISTS "home_categories" ("id" UUID , "name" VARCHAR(120) NOT NULL, "slug" VARCHAR(80) NOT NULL UNIQUE, "description" TEXT, "image_url" VARCHAR(255) NOT NULL, "is_active" BOOLEAN NOT NULL DEFAULT true, "display_order" INTEGER DEFAULT 0, "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id"));

CREATE TABLE IF NOT EXISTS "restaurant_home_categories" ("id" UUID NOT NULL  , "restaurant_id" UUID NOT NULL REFERENCES "restaurants" ("id") ON DELETE CASCADE ON UPDATE CASCADE , "home_category_id" UUID NOT NULL REFERENCES "home_categories" ("id") ON DELETE CASCADE ON UPDATE CASCADE , UNIQUE ("restaurant_id", "home_category_id"), PRIMARY KEY ("id")); COMMENT ON COLUMN "restaurant_home_categories"."id" IS 'Primary key for the restaurant-home category link'; COMMENT ON COLUMN "restaurant_home_categories"."restaurant_id" IS 'Reference to the restaurant'; COMMENT ON COLUMN "restaurant_home_categories"."home_category_id" IS 'Reference to the parent category';

CREATE TABLE IF NOT EXISTS "thematic_selections" ("id" UUID , "name" VARCHAR(150) NOT NULL, "description" TEXT, "home_category_id" UUID NOT NULL REFERENCES "home_categories" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "image_url" VARCHAR(255), "is_active" BOOLEAN NOT NULL DEFAULT true, "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id"));

DO 'BEGIN CREATE TYPE "public"."enum_promotions_type" AS ENUM(''percentage'', ''amount'', ''free_delivery'', ''buy_x_get_y'', ''other''); EXCEPTION WHEN duplicate_object THEN null; END';

DO 'BEGIN CREATE TYPE "public"."enum_promotions_scope" AS ENUM(''menu_item'', ''restaurant'', ''cart'', ''delivery'', ''global''); EXCEPTION WHEN duplicate_object THEN null; END';

CREATE TABLE IF NOT EXISTS "promotions" ("id" UUID , "title" VARCHAR(200) NOT NULL, "description" TEXT, "type" "public"."enum_promotions_type" NOT NULL, "scope" "public"."enum_promotions_scope" NOT NULL DEFAULT 'menu_item', "restaurant_id" UUID REFERENCES "restaurants" ("id") ON DELETE SET NULL ON UPDATE CASCADE, "menu_item_id" UUID REFERENCES "menu_items" ("id") ON DELETE SET NULL ON UPDATE CASCADE, "discount_value" DECIMAL(10,2), "currency" VARCHAR(10) NOT NULL DEFAULT 'DZD', "badge_text" VARCHAR(80), "custom_message" TEXT, "buy_quantity" INTEGER, "free_quantity" INTEGER, "start_date" TIMESTAMP WITH TIME ZONE, "end_date" TIMESTAMP WITH TIME ZONE, "is_active" BOOLEAN NOT NULL DEFAULT true, "metadata" JSON, "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id"));

CREATE TABLE IF NOT EXISTS "promotion_menu_items" ("id" UUID , "promotion_id" UUID NOT NULL REFERENCES "promotions" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "menu_item_id" UUID NOT NULL REFERENCES "menu_items" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, UNIQUE ("promotion_id", "menu_item_id"), PRIMARY KEY ("id"));

CREATE TABLE IF NOT EXISTS "daily_deals" ("id" UUID , "promotion_id" UUID NOT NULL REFERENCES "promotions" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "start_date" TIMESTAMP WITH TIME ZONE NOT NULL, "end_date" TIMESTAMP WITH TIME ZONE NOT NULL, "is_active" BOOLEAN NOT NULL DEFAULT true, "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id"));

CREATE TABLE IF NOT EXISTS "recommended_dishes" ("id" UUID , "restaurant_id" UUID NOT NULL REFERENCES "restaurants" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "menu_item_id" UUID NOT NULL REFERENCES "menu_items" ("id") ON DELETE CASCADE ON UPDATE CASCADE, "reason" TEXT, "is_active" BOOLEAN NOT NULL DEFAULT true, "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id"));

DO 'BEGIN CREATE TYPE "public"."enum_announcements_type" AS ENUM(''info'', ''success'', ''warning'', ''error''); EXCEPTION WHEN duplicate_object THEN null; END';

CREATE TABLE IF NOT EXISTS "announcements" ("id" UUID NOT NULL  , "title" VARCHAR(255) NOT NULL , "content" TEXT NOT NULL , "css_styles" TEXT , "js_scripts" TEXT , "type" "public"."enum_announcements_type" NOT NULL DEFAULT 'info' , "is_active" BOOLEAN NOT NULL DEFAULT true , "start_date" TIMESTAMP WITH TIME ZONE , "end_date" TIMESTAMP WITH TIME ZONE , "restaurant_id" UUID REFERENCES "restaurants" ("id") ON DELETE SET NULL ON UPDATE CASCADE , "created_at" TIMESTAMP WITH TIME ZONE NOT NULL, "updated_at" TIMESTAMP WITH TIME ZONE NOT NULL, PRIMARY KEY ("id")); COMMENT ON COLUMN "announcements"."id" IS 'Unique announcement identifier (UUID)'; COMMENT ON COLUMN "announcements"."title" IS 'Announcement title'; COMMENT ON COLUMN "announcements"."content" IS 'Announcement content (can include HTML)'; COMMENT ON COLUMN "announcements"."css_styles" IS 'Custom CSS styles'; COMMENT ON COLUMN "announcements"."js_scripts" IS 'Custom JavaScript'; COMMENT ON COLUMN "announcements"."type" IS 'Announcement type'; COMMENT ON COLUMN "announcements"."is_active" IS 'Whether the announcement is active'; COMMENT ON COLUMN "announcements"."start_date" IS 'When to start showing'; COMMENT ON COLUMN "announcements"."end_date" IS 'When to stop showing'; COMMENT ON COLUMN "announcements"."restaurant_id" IS 'Optional restaurant associated with this announcement';

CREATE INDEX IF NOT EXISTS "restaurants_status" ON "restaurants" ("status");

CREATE INDEX IF NOT EXISTS "restaurants_is_active" ON "restaurants" ("is_active");

CREATE INDEX IF NOT EXISTS "restaurants_is_premium" ON "restaurants" ("is_premium");

CREATE INDEX IF NOT EXISTS "restaurants_location_gix" ON "restaurants" USING gist ("location");

CREATE INDEX IF NOT EXISTS "food_categories_restaurant_id" ON "food_categories" ("restaurant_id");

CREATE INDEX IF NOT EXISTS "food_categories_restaurant_id_ordre_affichage" ON "food_categories" ("restaurant_id", "ordre_affichage");

CREATE INDEX IF NOT EXISTS "menu_items_category_id" ON "menu_items" ("category_id");

CREATE INDEX IF NOT EXISTS "menu_items_restaurant_id" ON "menu_items" ("restaurant_id");

CREATE INDEX IF NOT EXISTS "menu_items_restaurant_id_is_available_created_at" ON "menu_items" ("restaurant_id", "is_available", "created_at");

CREATE INDEX IF NOT EXISTS "additions_menu_item_id" ON "additions" ("menu_item_id");

CREATE INDEX IF NOT EXISTS "cashiers_restaurant_id" ON "cashiers" ("restaurant_id");

CREATE INDEX IF NOT EXISTS "cashiers_status" ON "cashiers" ("status");

CREATE UNIQUE INDEX IF NOT EXISTS "cashiers_cashier_code" ON "cashiers" ("cashier_code");

CREATE INDEX IF NOT EXISTS "drivers_status" ON "drivers" ("status");

CREATE INDEX IF NOT EXISTS "drivers_phone" ON "drivers" ("phone");

CREATE INDEX IF NOT EXISTS "drivers_driver_code" ON "drivers" ("driver_code");

CREATE INDEX IF NOT EXISTS "drivers_location_gix" ON "drivers" USING gist ("current_location");

CREATE INDEX IF NOT EXISTS "order_items_order_id" ON "order_items" ("order_id");

CREATE INDEX IF NOT EXISTS "order_items_menu_item_id" ON "order_items" ("menu_item_id");

CREATE INDEX IF NOT EXISTS "order_item_additions_order_item_id" ON "order_item_additions" ("order_item_id");

CREATE INDEX IF NOT EXISTS "order_item_additions_addition_id" ON "order_item_additions" ("addition_id");

CREATE UNIQUE INDEX IF NOT EXISTS "unique_client_meal_favorite" ON "favorite_meals" ("client_id", "meal_id");

CREATE INDEX IF NOT EXISTS "idx_favorite_meals_client_id" ON "favorite_meals" ("client_id");

CREATE INDEX IF NOT EXISTS "idx_favorite_meals_meal_id" ON "favorite_meals" ("meal_id");

CREATE INDEX IF NOT EXISTS "idx_favorite_meals_created_at" ON "favorite_meals" ("created_at");

CREATE UNIQUE INDEX IF NOT EXISTS "unique_client_restaurant_favorite" ON "favorite_restaurants" ("client_id", "restaurant_id");

CREATE INDEX IF NOT EXISTS "idx_favorite_restaurants_client_id" ON "favorite_restaurants" ("client_id");

CREATE INDEX IF NOT EXISTS "idx_favorite_restaurants_restaurant_id" ON "favorite_restaurants" ("restaurant_id");

CREATE INDEX IF NOT EXISTS "idx_favorite_restaurants_created_at" ON "favorite_restaurants" ("created_at");

CREATE INDEX IF NOT EXISTS "idx_favorite_restaurants_tags" ON "favorite_restaurants" USING GIN ("tags");

CREATE INDEX IF NOT EXISTS "admin_notifications_order_id" ON "admin_notifications" ("order_id");

CREATE INDEX IF NOT EXISTS "admin_notifications_restaurant_id" ON "admin_notifications" ("restaurant_id");

CREATE INDEX IF NOT EXISTS "admin_notifications_driver_id" ON "admin_notifications" ("driver_id");

CREATE INDEX IF NOT EXISTS "admin_notifications_is_read" ON "admin_notifications" ("is_read");

CREATE INDEX IF NOT EXISTS "admin_notifications_is_resolved" ON "admin_notifications" ("is_resolved");

CREATE INDEX IF NOT EXISTS "admin_notifications_created_at" ON "admin_notifications" ("created_at");

CREATE UNIQUE INDEX IF NOT EXISTS "system_configs_config_key" ON "system_configs" ("config_key");

CREATE UNIQUE INDEX IF NOT EXISTS "restaurant_home_categories_restaurant_id_home_category_id" ON "restaurant_home_categories" ("restaurant_id", "home_category_id");

CREATE INDEX IF NOT EXISTS "restaurant_home_categories_restaurant_id" ON "restaurant_home_categories" ("restaurant_id");

CREATE INDEX IF NOT EXISTS "restaurant_home_categories_home_category_id" ON "restaurant_home_categories" ("home_category_id");

CREATE UNIQUE INDEX IF NOT EXISTS "promotion_menu_items_promotion_id_menu_item_id" ON "promotion_menu_items" ("promotion_id", "menu_item_id");
