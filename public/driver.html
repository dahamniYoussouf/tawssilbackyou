<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Driver - Realtime Delivery</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f4f6fa;margin:0;padding:20px;min-height:100vh}
.container{max-width:700px;margin:0 auto}
h1{text-align:center;color:#0f62fe;margin-bottom:30px}
.section{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.1);margin-bottom:20px}
h2{margin-top:0;color:#0f62fe;font-size:18px;border-bottom:2px solid #e5e7eb;padding-bottom:10px}
input,button,select{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;font-size:14px}
button{background:#0f62fe;color:#fff;font-weight:bold;cursor:pointer;border:none}
button:hover{background:#084cd2}
button.success{background:#10b981}
button.success:hover{background:#059669}
button.online{background:#10b981;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.card{border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin:12px 0;background:#fafbff;position:relative}
.card.highlight{border-color:#0f62fe;border-width:2px;box-shadow:0 0 0 3px rgba(15,98,254,.1)}
.row{display:flex;gap:8px}
.row>*{flex:1}
.status-badge{display:inline-block;background:#eef2ff;border-radius:999px;padding:4px 12px;font-size:12px;font-weight:bold;color:#0f62fe}
.status-badge.online{background:#d1fae5;color:#065f46}
.status-badge.offline{background:#fee2e2;color:#991b1b}
.log{background:#0b1020;color:#d1fae5;padding:15px;border-radius:6px;height:250px;overflow:auto;font-family:monospace;font-size:12px}
.empty{color:#999;font-style:italic;text-align:center;padding:20px}
.delivery-badge{position:absolute;top:10px;right:10px;background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:bold}
.location-info{background:#f9fafb;padding:10px;border-radius:6px;margin:10px 0;font-size:13px}
.broadcast-notice{animation:slideIn 0.3s ease-out}
@keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
</style>
</head>
<body>
<div class="container">
<h1>ğŸ›µ Driver Portal</h1>

<div class="section">
<h2>ğŸ” Login</h2>
<input id="d_email" placeholder="Email" type="email" value="driver5@example.com">
<input id="d_password" type="password" placeholder="Password" value="password123">
<button onclick="driverLogin()">Login as Driver</button>
<div id="login_status" class="status-badge" style="display:none;margin-top:10px"></div>
</div>

<div class="section">
<h2>ğŸ¯ Status Management</h2>
<select id="status_select" onchange="changeStatus()" disabled>
  <option value="available">ğŸŸ¢ Available - Ready for deliveries</option>
  <option value="busy">ğŸŸ¡ Busy - On active delivery</option>
  <option value="offline">ğŸ”´ Offline - Not accepting orders</option>
  <option value="suspended">â›” Suspended - Account restricted</option>
</select>
<div id="status_info" style="margin-top:10px;font-size:13px;color:#666"></div>
</div>

<div class="section">
<h2>ğŸ“ Location & Status</h2>
<div class="row">
<input id="d_lat" placeholder="Latitude" value="36.75">
<input id="d_lng" placeholder="Longitude" value="2.8">
</div>
<button id="online_btn" onclick="toggleOnline()" disabled>ğŸŸ¢ Go Online</button>
<div id="driver_status" style="margin-top:10px"></div>
</div>

<div class="section">
<h2>ğŸš¨ Available Deliveries</h2>
<div id="d_deliveries">
<div class="empty">No deliveries available. Go online to receive requests!</div>
</div>
</div>

<div class="section">
<h2>ğŸ“Š Activity Log</h2>
<pre id="d_log" class="log">Waiting for connection...</pre>
</div>
</div>

<script>
let socket = null;
let auth = {role: null, token: null, user: null, profile: null};
let isOnline = false;
let locationInterval = null;

async function apiFetch(url, options = {}) {
  const token = auth.token || '';
  const headers = {
    'Content-Type': 'application/json',
    ...(options.headers || {}),
    ...(token ? { Authorization: `Bearer ${token}` } : {})
  };
  const response = await fetch(url, { ...options, headers });
  return response;
}

function log(...msg) {
  const e = document.getElementById('d_log');
  e.textContent = `[${new Date().toLocaleTimeString()}] ${msg.join(' ')}\n` + e.textContent;
}

function initSocket() {
  if (socket) {
    log('âš ï¸ Socket already exists');
    return;
  }
  
  log('ğŸ”Œ Connecting socket...');
  
  socket = io(location.origin, {
    auth: {token: auth.token}
  });
  
  socket.on('connect', () => {
    log('âœ… Socket connected! ID:', socket.id);
    log('ğŸ‘¤ Driver Profile ID:', auth.profile?.id);
    log('ğŸ“¡ Listening for deliveries...');
    document.getElementById('online_btn').disabled = false;
    
    // Manually join driver rooms
    if (auth.profile?.id) {
      socket.emit('join', `driver:${auth.profile.id}`);
      socket.emit('join', 'driver');
      socket.emit('join', 'drivers');
      log(`ğŸ“ Joined rooms: driver:${auth.profile.id}, driver, drivers`);
    }
  });
  
  socket.on('connect_error', (error) => {
    log('âŒ Connection error:', error.message);
  });
  
  // ğŸ“¡ Listen for BROADCAST to all drivers
  socket.on('order_broadcast', data => {
    log('ğŸ“¡ BROADCAST RECEIVED! New order available somewhere');
    log('Broadcast data:', JSON.stringify(data));
    
    // Show a subtle notification that there's an order available
    const box = document.getElementById('d_deliveries');
    const existingBroadcast = box.querySelector('.broadcast-notice');
    if (!existingBroadcast) {
      const notice = document.createElement('div');
      notice.className = 'card broadcast-notice';
      notice.style.background = '#fef3c7';
      notice.style.borderColor = '#f59e0b';
      notice.innerHTML = `
        <strong>ğŸ“¡ New Order Available!</strong>
        <p style="margin:5px 0;font-size:13px">An order was just placed. You may receive details if you're nearby.</p>
      `;
      box.prepend(notice);
      
      // Remove after 10 seconds
      setTimeout(() => notice.remove(), 10000);
    }
  });
  
  // ğŸš¨ Listen for SPECIFIC delivery (nearby drivers)
  socket.on('new_delivery', data => {
    log('ğŸš¨ NEW_DELIVERY EVENT RECEIVED!');
    log('Data:', JSON.stringify(data));
    handleNewDelivery(data);
  });
  
  // ğŸ“¬ General notification listener
  socket.on('notification', data => {
    log('ğŸ“¬ General Notification:', JSON.stringify(data));
    
    if (data.type === 'new_delivery' || data.orderId) {
      handleNewDelivery(data);
    }
  });
  
  socket.on('disconnect', () => {
    log('âŒ Disconnected');
  });
  
  // Debug: log ALL events received
  socket.onAny((event, ...args) => {
    log(`ğŸ”” Event: ${event}`, JSON.stringify(args));
  });
}

function handleNewDelivery(data) {
  log('ğŸš¨ Processing new delivery...');
  log('Order:', data.orderNumber, '| Distance:', data.distance, 'km');
  
  const box = document.getElementById('d_deliveries');
  if (box.querySelector('.empty')) box.innerHTML = '';
  
  const div = document.createElement('div');
  div.className = 'card highlight';
  div.innerHTML = `
    <div class="delivery-badge">NEW!</div>
    <strong style="font-size:18px;color:#0f62fe">Order #${data.orderNumber || data.orderId}</strong>
    <div class="location-info">
      <strong>ğŸ“ Distance:</strong> ${data.distance || '?'} km<br>
      <strong>ğŸ’° Delivery Fee:</strong> ${data.fee || 0} DA<br>
      <strong>ğŸ“ Address:</strong> ${data.deliveryAddress || 'Not specified'}<br>
      <strong>ğŸ´ Restaurant:</strong> ${data.restaurant || 'Restaurant'}
    </div>
    <button class="success" onclick="acceptDelivery('${data.orderId}')">âœ… Accept Delivery</button>
  `;
  box.prepend(div);
  
  // Browser notification
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('New Delivery Available! ğŸš¨', {
      body: `Order #${data.orderNumber} - ${data.distance} km away - ${data.fee} DA`,
      icon: 'ğŸ›µ',
      requireInteraction: true
    });
  }
  
  // Sound notification
  try {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSqGzvLRfzMGH2S77eeXQAoRVq/n7bJiGgU+lNrywn0pBSh+zPDajEULFlqx6P+oUxMJS6Hh8LdgGgU7k9r0xnktBSV7zPDajUMLFlqx6PCkWBMKTaPi8LJeGgU6ktjzx3ktBSR6y+/fjEULFlqw5/CmWhMKTqPl8bhgGQU8k9j0x3ktBSR6y+/fjEQLFVqx6O+pWxMKT6Pm8rxfGgU9lNr0xnksBS17y+/fjEQKFVmw6PCmWhMKT6Pl8bdgGQU9lNn0xnktBSV7y+/gjEQLFVmw6PKlWhIKTqPl8bdgGQU9lNn0xnktBSV7yu/gjEQLFVmw6O+oWxMKTqPi8LZgGgU7k9n0xngtBSV8y+/gjEURFViv6PCmWhMKTaPh8LZhGgU7k9j0xnktBSZ8yu/fjEURFViv5/CmWhMKTqLi8LdeGgU7k9j0xnktBSZ7yu/fjEQRFVmv5+6nWRMKT6Lk8bdeGgU+k9j0xnktBSZ7yu/fjEQRFViv5+6mWhMKT6Lk8bdeGgU+k9j0xnktBSZ7yu/fjEQRFVmv5+6lWhMKTqHj8rdcGQU9k9j0xnktBSZ8y+/gjEQRFViv5+6lWhMKTqDk8bdeGgU9k9n0xngtBSZ7yu/fjEQRFVmw5+6nWhMKT6Hj8rdcGQU9k9j0xngtBSZ7yu/gjEQQFVmv5+6nWhMKT6Hj8rdcGQU9k9j0xnktBSZ7yu/gjEQRFVmv5+6mWhMKTqHi8bdcGgU9k9j0xnktBSZ7yu/fjEQRFViv6O6mWhMKTqHi8bdcGgU9k9j0xnktBSR7yu/fjEQRFVmv6O6nWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/f');
    audio.volume = 0.5;
    audio.play().catch(e => console.log('Audio play failed:', e));
  } catch (e) {
    console.log('Audio notification failed:', e);
  }
}

async function driverLogin() {
  const email = document.getElementById('d_email').value;
  const password = document.getElementById('d_password').value;
  
  if (!email || !password) {
    alert('Please enter email and password');
    return;
  }
  
  log('ğŸ” Logging in...');
  
  try {
    const r = await fetch('/auth/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({email, password})
    });
    
    const j = await r.json();
    
    if (r.ok) {
      auth = {role: 'driver', token: j.access_token, user: j.user, profile: j.profile};
      
      document.getElementById('login_status').style.display = 'inline-block';
      document.getElementById('login_status').textContent = 'âœ… ' + (j.profile?.first_name || j.user.email);
      
      log('âœ… LOGGED IN');
      log('Driver Profile ID:', j.profile?.id);
      
      if (!j.profile?.id) {
        alert('âš ï¸ No driver profile found!');
        document.getElementById('online_btn').disabled = true;
        return;
      }
      
      initSocket();
      
      // Enable status management
      document.getElementById('status_select').disabled = false;
      loadCurrentStatus();
      
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    } else {
      alert('Login failed: ' + (j.message || 'Unknown'));
      log('âŒ Failed:', j.message);
    }
  } catch (e) {
    alert('Error: ' + e.message);
    log('âŒ Error:', e.message);
  }
}

async function changeStatus() {
  if (!auth.profile?.id) {
    alert('Please login first');
    return;
  }
  
  const newStatus = document.getElementById('status_select').value;
  
  if (newStatus === 'busy' && !auth.profile.active_order_id) {
    alert('Cannot set Busy manually. System sets it when you accept a delivery.');
    loadCurrentStatus();
    return;
  }
  
  if ((newStatus === 'offline' || newStatus === 'available') && auth.profile.active_order_id) {
    alert('Cannot change status while having an active delivery!');
    loadCurrentStatus();
    return;
  }
  
  log('ğŸ”„ Changing status to:', newStatus);
  
  try {
    const res = await apiFetch(`/driver/status`, {
      method: 'PATCH',
      body: JSON.stringify({ status: newStatus })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      log('âœ… Status updated to:', newStatus);
      updateStatusInfo(newStatus);
      
      isOnline = (newStatus === 'available');
      updateOnlineStatus();
    } else {
      alert('Error: ' + (data.message || 'Failed to update status'));
      log('âŒ Failed:', data.message);
      loadCurrentStatus();
    }
  } catch (e) {
    alert('Error: ' + e.message);
    log('âŒ Error:', e.message);
    loadCurrentStatus();
  }
}

async function loadCurrentStatus() {
  if (!auth.profile?.id) return;
  
  try {
    const res = await apiFetch(`/driver/${auth.profile.id}`);
    const data = await res.json();
    
    if (res.ok && data.data) {
      const driver = data.data;
      document.getElementById('status_select').value = driver.status;
      updateStatusInfo(driver.status);
      
      auth.profile.status = driver.status;
      auth.profile.active_order_id = driver.active_order_id;
      
      isOnline = (driver.status === 'available');
      updateOnlineStatus();
    }
  } catch (e) {
    log('âš ï¸ Failed to load status:', e.message);
  }
}

function updateStatusInfo(status) {
  const info = document.getElementById('status_info');
  
  const messages = {
    available: 'âœ… You are available and will receive delivery requests',
    busy: 'âš ï¸ You are busy with an active delivery',
    offline: 'ğŸ”´ You are offline and will not receive requests',
    suspended: 'â›” Your account is suspended. Contact support.'
  };
  
  info.textContent = messages[status] || '';
  info.style.color = status === 'suspended' ? '#dc2626' : '#666';
}

async function toggleOnline() {
  if (!auth.profile?.id) {
    alert('No driver profile!');
    return;
  }

  const lat = parseFloat(document.getElementById('d_lat').value);
  const lng = parseFloat(document.getElementById('d_lng').value);

  if (isNaN(lat) || isNaN(lng)) {
    alert('Invalid coordinates');
    return;
  }

  isOnline = !isOnline;

  if (isOnline) {
    log('ğŸŸ¢ GOING ONLINE...');

    try {
      const statusRes = await apiFetch(`/driver/status`, { 
        method: 'PATCH', 
        body: JSON.stringify({ status: 'available' }) 
      });

      if (!statusRes.ok) throw new Error('Failed to update status');

      const locationRes = await apiFetch(`/order/drivers/${auth.profile.id}/gps`, {
        method: 'PUT',
        body: JSON.stringify({ longitude: lng, latitude: lat })
      });
      if (!locationRes.ok) throw new Error('Failed to update location');

      log('âœ… NOW ONLINE');
      log(`Location: (${lat}, ${lng})`);

      document.getElementById('status_select').value = 'available';
      updateStatusInfo('available');

      locationInterval = setInterval(() => {
        const lat = parseFloat(document.getElementById('d_lat').value);
        const lng = parseFloat(document.getElementById('d_lng').value);
        if (!isNaN(lat) && !isNaN(lng)) {
          apiFetch(`/order/drivers/${auth.profile.id}/gps`, {
            method: 'PUT',
            body: JSON.stringify({ longitude: lng, latitude: lat })
          }).then(() => log('ğŸ“ Location updated'));
        }
      }, 30000);

    } catch (e) {
      log('âŒ Failed:', e.message);
      alert('Error: ' + e.message);
      isOnline = false;
    }

  } else {
    log('ğŸ”´ GOING OFFLINE...');

    try {
      if (locationInterval) {
        clearInterval(locationInterval);
        locationInterval = null;
      }

      const res = await apiFetch(`/driver/status`, { 
        method: 'PATCH', 
        body: JSON.stringify({ status: 'offline' }) 
      });

      if (!res.ok) throw new Error('Failed to update status');

      log('âœ… NOW OFFLINE');

      document.getElementById('status_select').value = 'offline';
      updateStatusInfo('offline');

    } catch (e) {
      log('âŒ Failed:', e.message);
      alert('Error: ' + e.message);
    }
  }

  updateOnlineStatus();
}

function updateOnlineStatus() {
  const btn = document.getElementById('online_btn');
  const status = document.getElementById('driver_status');
  
  if (isOnline) {
    btn.textContent = 'ğŸ”´ Go Offline';
    btn.className = 'online';
    status.innerHTML = '<span class="status-badge online">ğŸŸ¢ ONLINE</span>';
  } else {
    btn.textContent = 'ğŸŸ¢ Go Online';
    btn.className = '';
    status.innerHTML = '<span class="status-badge offline">ğŸ”´ OFFLINE</span>';
  }
}

async function acceptDelivery(orderId) {
  if (!auth.profile?.id) {
    alert('No driver profile!');
    return;
  }
  
  log('âœ… Accepting order', orderId);
  
  try {
    const r = await apiFetch(`/order/${orderId}/assign-driver`, {
      method: 'POST',
      body: JSON.stringify({ driver_id: auth.profile.id })
    });
    
    const j = await r.json();
    
    if (r.ok) {
      log('âœ… DELIVERY ACCEPTED!');
      
      const cards = document.getElementById('d_deliveries').querySelectorAll('.card');
      cards.forEach(card => {
        if (card.textContent.includes('#' + orderId) || card.textContent.includes(orderId)) {
          card.style.opacity = '0.5';
          card.querySelector('button').disabled = true;
          card.querySelector('button').textContent = 'âœ“ Accepted';
        }
      });
      
      loadCurrentStatus();
      
      alert('Delivery accepted!');
    } else {
      alert('Error: ' + (j.message || 'Could not accept'));
      log('âŒ Failed:', j.message);
    }
  } catch (e) {
    alert('Error: ' + e.message);
    log('âŒ Error:', e.message);
  }
}
</script>
</body>
</html>