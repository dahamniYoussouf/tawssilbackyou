<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Driver - Realtime Delivery</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f4f6fa;margin:0;padding:20px;min-height:100vh}
.container{max-width:900px;margin:0 auto}
h1{text-align:center;color:#0f62fe;margin-bottom:30px}
.section{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.1);margin-bottom:20px}
h2{margin-top:0;color:#0f62fe;font-size:18px;border-bottom:2px solid #e5e7eb;padding-bottom:10px;display:flex;justify-content:space-between;align-items:center}
h2 .count-badge{background:#eef2ff;color:#0f62fe;padding:4px 12px;border-radius:999px;font-size:14px;font-weight:bold}
input,button,select{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;font-size:14px}
button{background:#0f62fe;color:#fff;font-weight:bold;cursor:pointer;border:none}
button:hover{background:#084cd2}
button.success{background:#10b981}
button.success:hover{background:#059669}
button.danger{background:#dc2626}
button.danger:hover{background:#991b1b}
button.warning{background:#f59e0b}
button.warning:hover{background:#d97706}
button.online{background:#10b981;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.card{border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin:12px 0;background:#fafbff;position:relative}
.card.highlight{border-color:#0f62fe;border-width:2px;box-shadow:0 0 0 3px rgba(15,98,254,.1)}
.card.active-order{border-left:4px solid #10b981;background:#f0fdf4}
.row{display:flex;gap:8px}
.row>*{flex:1}
.status-badge{display:inline-block;background:#eef2ff;border-radius:999px;padding:4px 12px;font-size:12px;font-weight:bold;color:#0f62fe;margin:4px 0}
.status-badge.online{background:#d1fae5;color:#065f46}
.status-badge.offline{background:#fee2e2;color:#991b1b}
.status-badge.assigned{background:#dbeafe;color:#1e40af}
.status-badge.delivering{background:#fef3c7;color:#92400e}
.log{background:#0b1020;color:#d1fae5;padding:15px;border-radius:6px;height:250px;overflow:auto;font-family:monospace;font-size:12px}
.empty{color:#999;font-style:italic;text-align:center;padding:20px}
.delivery-badge{position:absolute;top:10px;right:10px;background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:bold}
.location-info{background:#f9fafb;padding:10px;border-radius:6px;margin:10px 0;font-size:13px}
.broadcast-notice{animation:slideIn 0.3s ease-out}
@keyframes slideIn{from{transform:translateY(-20px);opacity:0}to{transform:translateY(0);opacity:1}}
.capacity-info{background:#eef2ff;padding:12px;border-radius:8px;margin:15px 0;font-size:14px}
.capacity-bar{background:#e5e7eb;height:28px;border-radius:14px;overflow:hidden;margin-top:10px;position:relative}
.capacity-fill{background:linear-gradient(90deg, #10b981, #059669);height:100%;transition:width 0.3s;display:flex;align-items:center;justify-content:center;color:#fff;font-weight:bold;font-size:13px}
.capacity-fill.full{background:linear-gradient(90deg, #f59e0b, #d97706)}
.order-actions{display:flex;gap:8px;margin-top:12px}
.order-actions button{width:auto;padding:8px 16px;font-size:13px}
.order-number{font-size:16px;font-weight:bold;color:#0f62fe}
.tabs{display:flex;gap:8px;margin-bottom:16px;border-bottom:2px solid #e5e7eb}
.tab{padding:10px 20px;cursor:pointer;border:none;background:none;color:#666;font-weight:600;border-bottom:2px solid transparent;margin-bottom:-2px;transition:all 0.2s}
.tab:hover{color:#0f62fe}
.tab.active{color:#0f62fe;border-bottom-color:#0f62fe}
.tab-content{display:none}
.tab-content.active{display:block}
.tab .badge{background:#dc2626;color:#fff;padding:2px 8px;border-radius:10px;font-size:11px;margin-left:6px}
.order-route{background:#fff;padding:12px;border-radius:8px;margin:10px 0;border:1px solid #e5e7eb}
.route-step{display:flex;align-items:start;margin:8px 0;padding:8px;border-left:3px solid #e5e7eb;padding-left:12px}
.route-step.current{border-left-color:#10b981;background:#f0fdf4}
.route-step-icon{margin-right:10px;font-size:18px}
</style>
</head>
<body>
<div class="container">
<h1>ğŸ›µ Driver Portal</h1>

<div class="section">
<h2>ğŸ” Login</h2>
<input id="d_email" placeholder="Email" type="email" value="driver5@example.com">
<input id="d_password" type="password" placeholder="Password" value="password123">
<button onclick="driverLogin()">Login as Driver</button>
<div id="login_status" class="status-badge" style="display:none;margin-top:10px"></div>
</div>

<div class="section">
<h2>ğŸ¯ Status Management</h2>
<select id="status_select" onchange="changeStatus()" disabled>
  <option value="available">ğŸŸ¢ Available - Ready for deliveries</option>
  <option value="busy">ğŸŸ¡ Busy - On active delivery</option>
  <option value="offline">ğŸ”´ Offline - Not accepting orders</option>
  <option value="suspended">â›” Suspended - Account restricted</option>
</select>
<div id="status_info" style="margin-top:10px;font-size:13px;color:#666"></div>
</div>

<div class="section">
<h2>ğŸ“ Location & Status</h2>
<div class="row">
<input id="d_lat" placeholder="Latitude" value="36.75">
<input id="d_lng" placeholder="Longitude" value="2.8">
</div>
<button id="online_btn" onclick="toggleOnline()" disabled>ğŸŸ¢ Go Online</button>
<div id="driver_status" style="margin-top:10px"></div>

<!-- Capacity Info -->
<div id="capacity_display" style="display:none">
<div class="capacity-info">
  <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
    <strong>ğŸ“¦ Active Orders</strong>
    <span id="capacity_text">0 / 5</span>
  </div>
  <div class="capacity-bar">
    <div id="capacity_fill" class="capacity-fill" style="width:0%">0%</div>
  </div>
  <div style="margin-top:8px;font-size:12px;color:#666;text-align:center">
    <span id="capacity_message">Ready to accept orders</span>
  </div>
</div>
</div>
</div>

<!-- Active Orders Section -->
<div class="section" id="active_orders_section" style="display:none">
<h2>
  <span>ğŸšš My Active Orders</span>
  <span class="count-badge" id="active_count">0</span>
</h2>
<button onclick="loadActiveOrders()" style="margin-bottom:15px">ğŸ”„ Refresh Active Orders</button>
<div id="active_orders_list">
<div class="empty">No active orders</div>
</div>
</div>

<!-- Available Deliveries Section -->
<div class="section" id="deliveries_section" style="display:none">
<h2>ğŸš¨ Available Deliveries</h2>
<div class="tabs">
  <button class="tab active" onclick="switchTab('available')">
    ğŸ“‹ Available <span class="badge" id="available_count">0</span>
  </button>
  <button class="tab" onclick="switchTab('nearby')">
    ğŸ“ Nearby
  </button>
</div>

<div id="tab_available" class="tab-content active">
  <div id="d_deliveries">
    <div class="empty">No deliveries available. Go online to receive requests!</div>
  </div>
</div>

<div id="tab_nearby" class="tab-content">
  <button onclick="loadNearbyOrders()" style="margin-bottom:15px">ğŸ”„ Refresh Nearby</button>
  <div id="nearby_deliveries">
    <div class="empty">Click refresh to load nearby orders</div>
  </div>
</div>
</div>

<div class="section">
<h2>ğŸ“Š Activity Log</h2>
<pre id="d_log" class="log">Waiting for connection...</pre>
</div>
</div>

<script>
let socket = null;
let auth = {role: null, token: null, user: null, profile: null};
let isOnline = false;
let locationInterval = null;
let activeOrders = [];
let maxCapacity = 5;

async function apiFetch(url, options = {}) {
  const token = auth.token || '';
  const headers = {
    'Content-Type': 'application/json',
    ...(options.headers || {}),
    ...(token ? { Authorization: `Bearer ${token}` } : {})
  };
  const response = await fetch(url, { ...options, headers });
  return response;
}

function log(...msg) {
  const e = document.getElementById('d_log');
  e.textContent = `[${new Date().toLocaleTimeString()}] ${msg.join(' ')}\n` + e.textContent;
}

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  
  document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
  document.getElementById(`tab_${tabName}`).classList.add('active');
}

function updateCapacity() {
  const count = activeOrders.length;
  const percentage = (count / maxCapacity) * 100;
  
  document.getElementById('capacity_text').textContent = `${count} / ${maxCapacity}`;
  document.getElementById('capacity_fill').style.width = `${percentage}%`;
  document.getElementById('capacity_fill').textContent = `${Math.round(percentage)}%`;
  document.getElementById('active_count').textContent = count;
  
  const fill = document.getElementById('capacity_fill');
  if (count >= maxCapacity) {
    fill.classList.add('full');
    document.getElementById('capacity_message').textContent = 'âš ï¸ At maximum capacity';
  } else {
    fill.classList.remove('full');
    const remaining = maxCapacity - count;
    document.getElementById('capacity_message').textContent = `Can accept ${remaining} more order${remaining !== 1 ? 's' : ''}`;
  }
}

function initSocket() {
  if (socket) {
    log('âš ï¸ Socket already exists');
    return;
  }
  
  log('ğŸ”Œ Connecting socket...');
  
  socket = io(location.origin, {
    auth: {token: auth.token}
  });
  
  socket.on('connect', () => {
    log('âœ… Socket connected! ID:', socket.id);
    log('ğŸ‘¤ Driver Profile ID:', auth.profile?.id);
    log('ğŸ“¡ Listening for deliveries...');
    document.getElementById('online_btn').disabled = false;
    
    if (auth.profile?.id) {
      socket.emit('join', `driver:${auth.profile.id}`);
      socket.emit('join', 'driver');
      socket.emit('join', 'drivers');
      log(`ğŸ“ Joined rooms: driver:${auth.profile.id}, driver, drivers`);
    }
    
    loadActiveOrders();
  });
  
  socket.on('connect_error', (error) => {
    log('âŒ Connection error:', error.message);
  });
  
  socket.on('order_broadcast', data => {
    log('ğŸ“¡ BROADCAST: New order available somewhere');
    const availableCount = document.getElementById('available_count');
    availableCount.textContent = parseInt(availableCount.textContent || 0) + 1;
  });
  
  socket.on('new_delivery', data => {
    log('ğŸš¨ NEW_DELIVERY: Order assigned to you!');
    log('Data:', JSON.stringify(data));
    handleNewDelivery(data);
  });
  
  socket.on('notification', data => {
    log('ğŸ“¬ Notification:', JSON.stringify(data));
    
    if (data.type === 'new_delivery' || data.orderId) {
      handleNewDelivery(data);
    } else if (data.type === 'delivery_complete') {
      log(`âœ… Delivery completed! ${data.active_orders_count} order(s) remaining`);
      loadActiveOrders();
      updateCapacity();
    } else if (data.type === 'config_update') {
      log(`âš™ï¸ Config updated: ${data.message}`);
      maxCapacity = data.max_orders_per_driver || 5;
      updateCapacity();
    }
  });
  
  socket.on('disconnect', () => {
    log('âŒ Disconnected');
  });
  
  socket.onAny((event, ...args) => {
    log(`ğŸ”” Event: ${event}`, JSON.stringify(args));
  });
}

function handleNewDelivery(data) {
  log('ğŸš¨ Processing new delivery...');
  log('Order:', data.orderNumber, '| Distance:', data.distance, 'km');
  
  const box = document.getElementById('d_deliveries');
  if (box.querySelector('.empty')) box.innerHTML = '';
  
  const div = document.createElement('div');
  div.className = 'card highlight';
  div.id = `delivery_${data.orderId}`;
  
  // âœ… Check if driver can accept more orders
  const canAccept = activeOrders.length < maxCapacity;
  const buttonDisabled = canAccept ? '' : 'disabled style="opacity:0.5;cursor:not-allowed"';
  const buttonText = canAccept ? 'âœ… Accept Delivery' : 'âš ï¸ At Capacity';
  
  div.innerHTML = `
    <div class="delivery-badge">NEW!</div>
    <strong class="order-number">Order #${data.orderNumber || data.orderId}</strong>
    <div class="location-info">
      <strong>ğŸ“ Distance:</strong> ${data.distance || '?'} km<br>
      <strong>ğŸ’° Delivery Fee:</strong> ${data.fee || 0} DA<br>
      <strong>ğŸ“ Address:</strong> ${data.deliveryAddress || 'Not specified'}<br>
      <strong>ğŸ´ Restaurant:</strong> ${data.restaurant || 'Restaurant'}
    </div>
    <button class="success" onclick="acceptDelivery('${data.orderId}')" ${buttonDisabled}>${buttonText}</button>
  `;
  box.prepend(div);
  
  // Update available count
  const availableCount = document.getElementById('available_count');
  availableCount.textContent = box.querySelectorAll('.card:not(.capacity-warning)').length;
  
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('New Delivery Available! ğŸš¨', {
      body: `Order #${data.orderNumber} - ${data.distance} km away - ${data.fee} DA`,
      icon: 'ğŸ›µ',
      requireInteraction: true
    });
  }
  
  playNotificationSound();
}
async function loadActiveOrders() {
  if (!auth.profile?.id) return;
  
  log('ğŸ“¡ Loading active orders...');
  
  try {
    const res = await apiFetch('/driver/active-orders');
    const data = await res.json();
    
    if (res.ok) {
      activeOrders = data.data?.active_orders || [];
      maxCapacity = data.data?.capacity || 5;
      
      renderActiveOrders();
      updateCapacity();
      
      document.getElementById('active_orders_section').style.display = 'block';
      document.getElementById('capacity_display').style.display = 'block';
      
      log(`âœ… Loaded ${activeOrders.length} active orders`);
    } else {
      log('âŒ Failed to load active orders:', data.message);
    }
  } catch (error) {
    log('âŒ Error loading active orders:', error.message);
  }
}

function renderActiveOrders() {
  const box = document.getElementById('active_orders_list');
  
  if (activeOrders.length === 0) {
    box.innerHTML = '<div class="empty">No active orders</div>';
    return;
  }
  
  box.innerHTML = '';
  
  activeOrders.forEach((order, index) => {
    const div = document.createElement('div');
    div.className = 'card active-order';
    div.setAttribute('data-order', order.id);
    
    // âœ… Dynamic status badge color
    let statusBadgeClass = order.status;
    if (order.status === 'arrived') statusBadgeClass = 'delivering';
    
    div.innerHTML = `
      <strong class="order-number">#${order.order_number}</strong>
      <span class="status-badge ${statusBadgeClass}">${order.status.toUpperCase()}</span>
      
      <div class="order-route">
        <div class="route-step ${['assigned', 'arrived'].includes(order.status) ? 'current' : ''}">
          <div class="route-step-icon">ğŸ´</div>
          <div>
            <strong>${order.restaurant.name}</strong><br>
            <small style="color:#666">${order.restaurant.address}</small>
          </div>
        </div>
        <div class="route-step ${order.status === 'delivering' ? 'current' : ''}">
          <div class="route-step-icon">ğŸ“</div>
          <div>
            <strong>Delivery Address</strong><br>
            <small style="color:#666">${order.delivery_address}</small>
          </div>
        </div>
      </div>
      
      <div class="location-info">
        <strong>ğŸ’° Amount:</strong> ${order.total_amount} DA<br>
        <strong>ğŸ“ Client:</strong> Contact via app<br>
        <strong>â° Assigned:</strong> ${new Date(order.assigned_at).toLocaleTimeString()}
      </div>
      
      <div class="order-actions">
        <button onclick="showRoutePreview('${order.id}')">ğŸ” Distances</button>
        
        ${order.status === 'assigned' ? `
          <button onclick="markArrived('${order.id}')">ğŸ“ Arrived at Restaurant</button>
        ` : ''}
        
        ${order.status === 'arrived' ? `
          <button class="success" onclick="startDelivery('${order.id}')">ğŸš€ Start Delivery</button>
        ` : ''}
        
        ${order.status === 'delivering' ? `
          <button class="success" onclick="completeDelivery('${order.id}')">âœ… Complete Delivery</button>
        ` : ''}
        
        <button class="danger" onclick="cancelOrder('${order.id}')">âŒ Cancel</button>
      </div>
      <div class='route-preview'></div>
    `;
    box.appendChild(div);
  });
}
async function loadNearbyOrders() {
  if (!auth.profile?.id) return;
  
  log('ğŸ“ Loading nearby orders...');
  
  try {
    const res = await apiFetch('/order/nearby?radius=5000&pageSize=20');
    const data = await res.json();
    
    if (res.ok) {
      const orders = data.data || [];
      const box = document.getElementById('nearby_deliveries');
      
      if (orders.length === 0) {
        box.innerHTML = '<div class="empty">No nearby orders found</div>';
        return;
      }
      
      box.innerHTML = '';
      
      orders.forEach(order => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <strong class="order-number">Order #${order.order_number}</strong>
          <div class="location-info">
            <strong>ğŸ“ Distance:</strong> ${order.distance_km} km<br>
            <strong>ğŸ’° Fee:</strong> ${order.delivery_fee} DA<br>
            <strong>ğŸ“ Address:</strong> ${order.delivery_address}<br>
            <strong>ğŸ´ Restaurant:</strong> ${order.restaurant.name}
          </div>
          <button class="success" onclick="acceptDelivery('${order.id}')">âœ… Accept</button>
        `;
        box.appendChild(div);
      });
      
      log(`âœ… Loaded ${orders.length} nearby orders`);
    }
  } catch (error) {
    log('âŒ Error loading nearby orders:', error.message);
  }
}

async function driverLogin() {
  const email = document.getElementById('d_email').value;
  const password = document.getElementById('d_password').value;
  
  if (!email || !password) {
    alert('Please enter email and password');
    return;
  }
  
  log('ğŸ” Logging in...');
  
  try {
    const r = await fetch('/auth/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({email, password, type:'driver'})
    });
    
    const j = await r.json();
    
    if (r.ok) {
      auth = {role: 'driver', token: j.access_token, user: j.user, profile: j.profile};
      
      document.getElementById('login_status').style.display = 'inline-block';
      document.getElementById('login_status').textContent = 'âœ… ' + (j.profile?.first_name || j.user.email);
      
      log('âœ… LOGGED IN');
      log('Driver Profile ID:', j.profile?.id);
      
      if (!j.profile?.id) {
        alert('âš ï¸ No driver profile found!');
        document.getElementById('online_btn').disabled = true;
        return;
      }
      
      initSocket();
      document.getElementById('status_select').disabled = false;
      document.getElementById('deliveries_section').style.display = 'block';
      loadCurrentStatus();
      
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    } else {
      alert('Login failed: ' + (j.message || 'Unknown'));
      log('âŒ Failed:', j.message);
    }
  } catch (e) {
    alert('Error: ' + e.message);
    log('âŒ Error:', e.message);
  }
}

async function changeStatus() {
  if (!auth.profile?.id) {
    alert('Please login first');
    return;
  }
  
  const newStatus = document.getElementById('status_select').value;
  
  if (newStatus === 'busy' && activeOrders.length === 0) {
    alert('Cannot set Busy manually. System sets it when you accept deliveries.');
    loadCurrentStatus();
    return;
  }
  
  if ((newStatus === 'offline' || newStatus === 'available') && activeOrders.length > 0) {
    alert('Cannot change status while having active deliveries!');
    loadCurrentStatus();
    return;
  }
  
  log('ğŸ”„ Changing status to:', newStatus);
  
  try {
    const res = await apiFetch(`/driver/status`, {
      method: 'PATCH',
      body: JSON.stringify({ status: newStatus })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      log('âœ… Status updated to:', newStatus);
      updateStatusInfo(newStatus);
      isOnline = (newStatus === 'available');
      updateOnlineStatus();
    } else {
      alert('Error: ' + (data.message || 'Failed to update status'));
      log('âŒ Failed:', data.message);
      loadCurrentStatus();
    }
  } catch (e) {
    alert('Error: ' + e.message);
    log('âŒ Error:', e.message);
    loadCurrentStatus();
  }
}

async function loadCurrentStatus() {
  if (!auth.profile?.id) return;
  
  try {
    const res = await apiFetch(`/driver/${auth.profile.id}`);
    const data = await res.json();
    
    if (res.ok && data.data) {
      const driver = data.data;
      document.getElementById('status_select').value = driver.status;
      updateStatusInfo(driver.status);
      auth.profile.status = driver.status;
      isOnline = (driver.status === 'available');
      updateOnlineStatus();
    }
  } catch (e) {
    log('âš ï¸ Failed to load status:', e.message);
  }
}

function updateStatusInfo(status) {
  const info = document.getElementById('status_info');
  const messages = {
    available: 'âœ… You are available and will receive delivery requests',
    busy: 'âš ï¸ You are busy with active deliveries',
    offline: 'ğŸ”´ You are offline and will not receive requests',
    suspended: 'â›” Your account is suspended. Contact support.'
  };
  info.textContent = messages[status] || '';
  info.style.color = status === 'suspended' ? '#dc2626' : '#666';
}

async function toggleOnline() {
  if (!auth.profile?.id) {
    alert('No driver profile!');
    return;
  }

  const lat = parseFloat(document.getElementById('d_lat').value);
  const lng = parseFloat(document.getElementById('d_lng').value);

  if (isNaN(lat) || isNaN(lng)) {
    alert('Invalid coordinates');
    return;
  }

  isOnline = !isOnline;

  if (isOnline) {
    log('ğŸŸ¢ GOING ONLINE...');

    try {
      const statusRes = await apiFetch(`/driver/status`, { 
        method: 'PATCH', 
        body: JSON.stringify({ status: 'available' }) 
      });

      if (!statusRes.ok) throw new Error('Failed to update status');

      const locationRes = await apiFetch(`/order/drivers/${auth.profile.id}/gps`, {
        method: 'PUT',
        body: JSON.stringify({ longitude: lng, latitude: lat })
      });
      if (!locationRes.ok) throw new Error('Failed to update location');

      log('âœ… NOW ONLINE');
      log(`Location: (${lat}, ${lng})`);

      document.getElementById('status_select').value = 'available';
      updateStatusInfo('available');

      locationInterval = setInterval(() => {
        const lat = parseFloat(document.getElementById('d_lat').value);
        const lng = parseFloat(document.getElementById('d_lng').value);
        if (!isNaN(lat) && !isNaN(lng)) {
          apiFetch(`/order/drivers/${auth.profile.id}/gps`, {
            method: 'PUT',
            body: JSON.stringify({ longitude: lng, latitude: lat })
          }).then(() => log('ğŸ“ Location updated'));
        }
      }, 30000);

    } catch (e) {
      log('âŒ Failed:', e.message);
      alert('Error: ' + e.message);
      isOnline = false;
    }

  } else {
    log('ğŸ”´ GOING OFFLINE...');

    try {
      if (locationInterval) {
        clearInterval(locationInterval);
        locationInterval = null;
      }

      const res = await apiFetch(`/driver/status`, { 
        method: 'PATCH', 
        body: JSON.stringify({ status: 'offline' }) 
      });

      if (!res.ok) throw new Error('Failed to update status');

      log('âœ… NOW OFFLINE');

      document.getElementById('status_select').value = 'offline';
      updateStatusInfo('offline');

    } catch (e) {
      log('âŒ Failed:', e.message);
      alert('Error: ' + e.message);
    }
  }

  updateOnlineStatus();
}

function updateOnlineStatus() {
  const btn = document.getElementById('online_btn');
  const status = document.getElementById('driver_status');
  
  if (isOnline) {
    btn.textContent = 'ğŸ”´ Go Offline';
    btn.className = 'online';
    status.innerHTML = '<span class="status-badge online">ğŸŸ¢ ONLINE</span>';
  } else {
    btn.textContent = 'ğŸŸ¢ Go Online';
    btn.className = '';
    status.innerHTML = '<span class="status-badge offline">ğŸ”´ OFFLINE</span>';
  }
}
// âœ… NEW: Update available delivery buttons based on capacity
function updateAvailableDeliveryButtons() {
  const canAcceptMore = activeOrders.length < maxCapacity;
  
  // Get all accept buttons in available deliveries
  const acceptButtons = document.querySelectorAll('#d_deliveries .card button.success');
  
  acceptButtons.forEach(button => {
    if (canAcceptMore) {
      button.disabled = false;
      button.style.opacity = '1';
      button.style.cursor = 'pointer';
    } else {
      button.disabled = true;
      button.style.opacity = '0.5';
      button.style.cursor = 'not-allowed';
      button.textContent = 'âš ï¸ At Capacity';
    }
  });
  
  // Show/hide message
  if (!canAcceptMore) {
    const deliveriesBox = document.getElementById('d_deliveries');
    if (!deliveriesBox.querySelector('.capacity-warning')) {
      const warning = document.createElement('div');
      warning.className = 'card capacity-warning';
      warning.style.background = '#fef3c7';
      warning.style.borderLeft = '4px solid #f59e0b';
      warning.innerHTML = `
        <strong>âš ï¸ Maximum Capacity Reached</strong><br>
        <span style="font-size:13px">Complete some deliveries to accept more orders (${activeOrders.length}/${maxCapacity})</span>
      `;
      deliveriesBox.prepend(warning);
    }
  } else {
    // Remove warning if it exists
    const warning = document.querySelector('.capacity-warning');
    if (warning) warning.remove();
  }
}
async function acceptDelivery(orderId) {
  if (!auth.profile?.id) {
    alert('No driver profile!');
    return;
  }
  
  // Check capacity
  if (activeOrders.length >= maxCapacity) {
    alert(`âš ï¸ You are at maximum capacity (${maxCapacity} orders). Please complete some deliveries first.`);
    return;
  }
  
  log('âœ… Accepting order', orderId);
  
  try {
    const r = await apiFetch(`/order/${orderId}/assign-driver`, {
      method: 'POST',
      body: JSON.stringify({ driver_id: auth.profile.id })
    });
    
    const j = await r.json();
    
    if (r.ok) {
      log('âœ… DELIVERY ACCEPTED!');
      
      // Remove from available list
      const card = document.getElementById(`delivery_${orderId}`);
      if (card) card.remove();
      
      // Update available count
      const availableCount = document.getElementById('available_count');
      const remaining = document.querySelectorAll('#d_deliveries .card:not(.capacity-warning)').length;
      availableCount.textContent = remaining;
      
      // âœ… Reload active orders
      await loadActiveOrders();
      
      // âœ… NEW: Update available delivery buttons based on new capacity
      updateAvailableDeliveryButtons();
      
      alert('Delivery accepted! Check your active orders.');
    } else {
      alert('Error: ' + (j.message || 'Could not accept'));
      log('âŒ Failed:', j.message);
    }
  } catch (e) {
    alert('Error: ' + e.message);
    log('âŒ Error:', e.message);
  }
}
async function startDelivery(orderId) {
  log('ğŸš€ Starting delivery:', orderId);
  
  try {
    const res = await apiFetch(`/order/${orderId}/start-delivery`, {
      method: 'POST'
    });
    
    if (res.ok) {
      log('âœ… Delivery started');
      await loadActiveOrders();
    } else {
      const data = await res.json();
      alert('Error: ' + (data.message || 'Failed to start delivery'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
    log('âŒ Error:', error.message);
  }
}

async function completeDelivery(orderId) {
  log('âœ… Completing delivery:', orderId);
  
  try {
    const res = await apiFetch(`/order/${orderId}/complete-delivery`, {
      method: 'POST'
    });
    
    if (res.ok) {
      log('âœ… Delivery completed!');
      await loadActiveOrders();
      
      // âœ… NEW: Re-enable available delivery buttons
      updateAvailableDeliveryButtons();
      
      alert('Delivery completed successfully! ğŸ‰');
    } else {
      const data = await res.json();
      alert('Error: ' + (data.message || 'Failed to complete delivery'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
    log('âŒ Error:', error.message);
  }
}
// âœ… FIXED: Updated cancelOrder function for driver.html
// Replace the existing cancelOrder function with this one

async function cancelOrder(orderId) {
  const reason = prompt('âš ï¸ Why are you canceling this order?\n\nPlease provide a detailed reason (minimum 10 characters):');
  
  if (!reason || reason.trim().length < 10) {
    alert('Cancellation reason must be at least 10 characters');
    return;
  }
  
  if (!confirm(`Are you sure you want to cancel this order?\n\nReason: ${reason}\n\nNote: Multiple cancellations may affect your account.`)) {
    return;
  }
  
  log('âŒ Canceling order:', orderId);
  
  try {
    const res = await apiFetch(`/order/${orderId}/driver-cancel`, {
      method: 'POST',
      body: JSON.stringify({ reason: reason.trim() })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      log('âœ… Order cancelled successfully');
      
      // Show warning if exists
      if (data.warning) {
        alert('âš ï¸ ' + data.warning);
      }
      
      // âœ… FIX: Force reload active orders immediately
      await loadActiveOrders();
      
      // âœ… FIX: Update capacity display
      updateCapacity();
      updateAvailableDeliveryButtons();

      // Show success message
      alert('Order cancelled successfully. The system will find another driver.');
      
      log(`ğŸ“Š Updated active orders: ${activeOrders.length} remaining`);
    } else {
      alert('Error: ' + (data.message || 'Failed to cancel order'));
      log('âŒ Failed:', data.message);
    }
  } catch (error) {
    alert('Error: ' + error.message);
    log('âŒ Error:', error.message);
  }
}
// Listen for server warnings about cancellations
socket.on('driver:cancellation_threshold', (payload) => {
  const box = document.getElementById('driver_notifications');
  if (box) {
    const note = document.createElement('div');
    note.className = 'order warning';
    note.style.border = '1px solid #f59e0b';
    note.style.background = '#fff7ed';
    note.style.padding = '10px';
    note.style.borderRadius = '8px';
    note.style.margin = '6px 0';
    note.innerHTML = `<strong>âš ï¸ Attention:</strong> ${payload.message} (annulations: ${payload.cancellation_count})`;
    box.prepend(note);
    playNotificationSound();
  }
});

function playNotificationSound() {
  try {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSqGzvLRfzMGH2S77eeXQAoRVq/n7bJiGgU+lNrywn0pBSh+zPDajEULFlqx6P+oUxMJS6Hh8LdgGgU7k9r0xnktBSV7zPDajUMLFlqx6PCkWBMKTaPi8LJeGgU6ktjzx3ktBSR6y+/fjEULFlqw5/CmWhMKTqPl8bhgGQU8k9j0x3ktBSR6y+/fjEQLFVqx6O+pWxMKT6Pm8rxfGgU9lNr0xnksBS17y+/fjEQKFVmw6PCmWhMKT6Pl8bdgGQU9lNn0xnktBSV7y+/gjEQLFVmw6PKlWhIKTqPl8bdgGQU9lNn0xnktBSV7yu/gjEQLFVmw6O+oWxMKTqPi8LZgGgU7k9n0xngtBSV8y+/gjEURFViv6PCmWhMKTaPh8LZhGgU7k9j0xnktBSZ8yu/fjEURFViv5/CmWhMKTqLi8LdeGgU7k9j0xnktBSZ7yu/fjEQRFVmv5+6nWRMKT6Lk8bdeGgU+k9j0xnktBSZ7yu/fjEQRFViv5+6mWhMKT6Lk8bdeGgU+k9j0xnktBSZ7yu/fjEQRFVmv5+6lWhMKTqHj8rdcGQU9k9j0xnktBSZ8y+/gjEQRFViv5+6lWhMKTqDk8bdeGgU9k9n0xngtBSZ7yu/fjEQRFVmw5+6nWhMKT6Hj8rdcGQU9k9j0xngtBSZ7yu/gjEQQFVmv5+6nWhMKT6Hj8rdcGQU9k9j0xnktBSZ7yu/gjEQRFVmv5+6mWhMKTqHi8bdcGgU9k9j0xnktBSZ7yu/fjEQRFViv6O6mWhMKTqHi8bdcGgU9k9j0xnktBSR7yu/fjEQRFVmv6O6nWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/f');
    audio.volume = 0.5;
    audio.play().catch(e => console.log('Audio play failed:', e));
  } catch (e) {
    console.log('Audio notification failed:', e);
  }
}

async function markArrived(orderId) {
  log('ğŸ“ Marking arrival at restaurant:', orderId);
  
  try {
    const res = await apiFetch(`/order/${orderId}/arrived`, {
      method: 'POST'
    });
    
    if (res.ok) {
      log('âœ… Marked as arrived at restaurant');
      await loadActiveOrders();
      
      // Show route preview
      const orderCard = document.querySelector(`[data-order="${orderId}"]`);
      if (orderCard) {
        const previewDiv = orderCard.querySelector('.route-preview');
        if (previewDiv) {
          previewDiv.innerHTML = '<div style="color:#10b981;font-size:13px;padding:10px;background:#f0fdf4;border-radius:6px;margin-top:10px">âœ… Arrived at restaurant. Waiting for order pickup...</div>';
        }
      }
    } else {
      const data = await res.json();
      alert('Error: ' + (data.message || 'Failed to mark arrival'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
    log('âŒ Error:', error.message);
  }
}
</script>
</body>
</html>