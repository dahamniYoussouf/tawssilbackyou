<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Driver - Realtime Delivery</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f4f6fa;margin:0;padding:20px;min-height:100vh}
.container{max-width:700px;margin:0 auto}
h1{text-align:center;color:#0f62fe;margin-bottom:30px}
.section{background:#fff;padding:20px;border-radius:10px;box-shadow:0 4px 10px rgba(0,0,0,.1);margin-bottom:20px}
h2{margin-top:0;color:#0f62fe;font-size:18px;border-bottom:2px solid #e5e7eb;padding-bottom:10px}
input,button,select{width:100%;padding:10px;margin:6px 0;border:1px solid #ccc;border-radius:6px;box-sizing:border-box;font-size:14px}
button{background:#0f62fe;color:#fff;font-weight:bold;cursor:pointer;border:none}
button:hover{background:#084cd2}
button.success{background:#10b981}
button.success:hover{background:#059669}
button.online{background:#10b981;animation:pulse 2s infinite}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.7}}
.card{border:1px solid #e5e7eb;border-radius:8px;padding:16px;margin:12px 0;background:#fafbff;position:relative}
.card.highlight{border-color:#0f62fe;border-width:2px;box-shadow:0 0 0 3px rgba(15,98,254,.1)}
.row{display:flex;gap:8px}
.row>*{flex:1}
.status-badge{display:inline-block;background:#eef2ff;border-radius:999px;padding:4px 12px;font-size:12px;font-weight:bold;color:#0f62fe}
.status-badge.online{background:#d1fae5;color:#065f46}
.status-badge.offline{background:#fee2e2;color:#991b1b}
.log{background:#0b1020;color:#d1fae5;padding:15px;border-radius:6px;height:250px;overflow:auto;font-family:monospace;font-size:12px}
.empty{color:#999;font-style:italic;text-align:center;padding:20px}
.delivery-badge{position:absolute;top:10px;right:10px;background:#fef3c7;color:#92400e;padding:4px 10px;border-radius:6px;font-size:11px;font-weight:bold}
.location-info{background:#f9fafb;padding:10px;border-radius:6px;margin:10px 0;font-size:13px}
</style>
</head>
<body>
<div class="container">
<h1>🛵 Driver Portal</h1>

<div class="section">
<h2>🔐 Login</h2>
<input id="d_email" placeholder="Email" type="email">
<input id="d_password" type="password" placeholder="Password">
<button onclick="driverLogin()">Login as Driver</button>
<div id="login_status" class="status-badge" style="display:none;margin-top:10px"></div>
</div>

<div class="section">
<h2>🎯 Status Management</h2>
<select id="status_select" onchange="changeStatus()" disabled>
  <option value="available">🟢 Available - Ready for deliveries</option>
  <option value="busy">🟡 Busy - On active delivery</option>
  <option value="offline">🔴 Offline - Not accepting orders</option>
  <option value="suspended">⛔ Suspended - Account restricted</option>
</select>
<div id="status_info" style="margin-top:10px;font-size:13px;color:#666"></div>
</div>

<div class="section">
<h2>📍 Location & Status</h2>
<div class="row">
<input id="d_lat" placeholder="Latitude" value="36.75">
<input id="d_lng" placeholder="Longitude" value="3.04">
</div>
<button id="online_btn" onclick="toggleOnline()" disabled>🟢 Go Online</button>
<div id="driver_status" style="margin-top:10px"></div>
</div>

<div class="section">
<h2>🚨 Available Deliveries</h2>
<div id="d_deliveries">
<div class="empty">No deliveries available. Go online to receive requests!</div>
</div>
</div>

<div class="section">
<h2>📊 Activity Log</h2>
<pre id="d_log" class="log">Waiting for connection...</pre>
</div>
</div>

<script>
let socket = null;
let auth = {role: null, token: null, user: null, profile: null};
let isOnline = false;
let locationInterval = null;

function log(...msg) {
  const e = document.getElementById('d_log');
  e.textContent = `[${new Date().toLocaleTimeString()}] ${msg.join(' ')}\n` + e.textContent;
}

function headers() {
  return {'Content-Type': 'application/json', Authorization: `Bearer ${auth.token || ''}`};
}

function initSocket() {
  if (socket) {
    log('⚠️ Socket already exists');
    return;
  }
  
  log('🔌 Connecting socket...');
  
  socket = io(location.origin, {
    auth: {token: auth.token}
  });
  
  socket.on('connect', () => {
    log('✅ Socket connected! ID:', socket.id);
    document.getElementById('online_btn').disabled = false;
  });
  
  socket.on('connect_error', (error) => {
    log('❌ Connection error:', error.message);
  });
  
  socket.on('notification', data => {
    log('📬 Notification:', JSON.stringify(data));
  });
  
  socket.on('new_delivery', data => {
    log('🚨 NEW DELIVERY!');
    log('Order:', data.orderNumber, '| Distance:', data.distance, 'km');
    
    const box = document.getElementById('d_deliveries');
    if (box.querySelector('.empty')) box.innerHTML = '';
    
    const div = document.createElement('div');
    div.className = 'card highlight';
    div.innerHTML = `
      <div class="delivery-badge">NEW!</div>
      <strong style="font-size:18px;color:#0f62fe">Order #${data.orderNumber || data.orderId}</strong>
      <div class="location-info">
        <strong>📍 Distance:</strong> ${data.distance || '?'} km<br>
        <strong>📍 Address:</strong> ${data.deliveryAddress || 'Not specified'}<br>
        <strong>🍴 Restaurant:</strong> ${data.restaurant || 'Restaurant'}
      </div>
      <button class="success" onclick="acceptDelivery('${data.orderId}')">✅ Accept Delivery</button>
    `;
    box.prepend(div);
    
    if ('Notification' in window && Notification.permission === 'granted') {
      new Notification('New Delivery!', {
        body: `Order #${data.orderNumber} - ${data.distance} km away`
      });
    }
  });
  
  socket.on('disconnect', () => {
    log('❌ Disconnected');
  });
}

async function driverLogin() {
  const email = document.getElementById('d_email').value;
  const password = document.getElementById('d_password').value;
  
  if (!email || !password) {
    alert('Please enter email and password');
    return;
  }
  
  log('🔐 Logging in...');
  
  try {
    const r = await fetch('/auth/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({email, password})
    });
    
    const j = await r.json();
    
    if (r.ok) {
      auth = {role: 'driver', token: j.access_token, user: j.user, profile: j.profile};
      
      document.getElementById('login_status').style.display = 'inline-block';
      document.getElementById('login_status').textContent = '✅ ' + (j.profile?.first_name || j.user.email);
      
      log('✅ LOGGED IN');
      log('Driver Profile ID:', j.profile?.id);
      
      if (!j.profile?.id) {
        alert('⚠️ No driver profile found!');
        document.getElementById('online_btn').disabled = true;
        return;
      }
      
      initSocket();
      
      // Enable status management
      document.getElementById('status_select').disabled = false;
      loadCurrentStatus();
      
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    } else {
      alert('Login failed: ' + (j.message || 'Unknown'));
      log('❌ Failed:', j.message);
    }
  } catch (e) {
    alert('Error: ' + e.message);
    log('❌ Error:', e.message);
  }
}

async function changeStatus() {
  if (!auth.profile?.id) {
    alert('Please login first');
    return;
  }
  
  const newStatus = document.getElementById('status_select').value;
  
  // Prevent changing to busy manually
  if (newStatus === 'busy' && !auth.profile.active_order_id) {
    alert('Cannot set Busy manually. System sets it when you accept a delivery.');
    loadCurrentStatus();
    return;
  }
  
  // Prevent changing status if has active order
  if ((newStatus === 'offline' || newStatus === 'available') && auth.profile.active_order_id) {
    alert('Cannot change status while having an active delivery!');
    loadCurrentStatus();
    return;
  }
  
  log('🔄 Changing status to:', newStatus);
  
  try {
    const res = await fetch(`/driver/${auth.profile.id}/status`, {
      method: 'PATCH',
      headers: headers(),
      body: JSON.stringify({status: newStatus})
    });
    
    const data = await res.json();
    
    if (res.ok) {
      log('✅ Status updated to:', newStatus);
      updateStatusInfo(newStatus);
      
      // Sync with go online/offline button
      isOnline = (newStatus === 'available');
      updateOnlineStatus();
    } else {
      alert('Error: ' + (data.message || 'Failed to update status'));
      log('❌ Failed:', data.message);
      loadCurrentStatus();
    }
  } catch (e) {
    alert('Error: ' + e.message);
    log('❌ Error:', e.message);
    loadCurrentStatus();
  }
}

async function loadCurrentStatus() {
  if (!auth.profile?.id) return;
  
  try {
    const res = await fetch(`/driver/${auth.profile.id}`, {
      headers: headers()
    });
    
    const data = await res.json();
    
    if (res.ok && data.data) {
      const driver = data.data;
      document.getElementById('status_select').value = driver.status;
      updateStatusInfo(driver.status);
      
      auth.profile.status = driver.status;
      auth.profile.active_order_id = driver.active_order_id;
      
      isOnline = (driver.status === 'available');
      updateOnlineStatus();
    }
  } catch (e) {
    log('⚠️ Failed to load status:', e.message);
  }
}

function updateStatusInfo(status) {
  const info = document.getElementById('status_info');
  
  const messages = {
    available: '✅ You are available and will receive delivery requests',
    busy: '⚠️ You are busy with an active delivery',
    offline: '🔴 You are offline and will not receive requests',
    suspended: '⛔ Your account is suspended. Contact support.'
  };
  
  info.textContent = messages[status] || '';
  info.style.color = status === 'suspended' ? '#dc2626' : '#666';
}

async function toggleOnline() {
  if (!auth.profile?.id) {
    alert('No driver profile!');
    return;
  }
  
  const lat = parseFloat(document.getElementById('d_lat').value);
  const lng = parseFloat(document.getElementById('d_lng').value);
  
  if (isNaN(lat) || isNaN(lng)) {
    alert('Invalid coordinates');
    return;
  }
  
  isOnline = !isOnline;
  
  if (isOnline) {
    log('🟢 GOING ONLINE...');
    
    try {
      // Update status
      const statusRes = await fetch(`/driver/${auth.profile.id}/status`, {
        method: 'PATCH',
        headers: headers(),
        body: JSON.stringify({status: 'available'})
      });
      
      if (!statusRes.ok) throw new Error('Failed to update status');
      
      // Update location
      const locationRes = await fetch(`/order/drivers/${auth.profile.id}/gps`, {
        method: 'PUT',
        headers: headers(),
        body: JSON.stringify({longitude: lng, latitude: lat})
      });
      
      if (!locationRes.ok) throw new Error('Failed to update location');
      
      log('✅ NOW ONLINE');
      log('Location: (' + lat + ', ' + lng + ')');
      
      // Sync status dropdown
      document.getElementById('status_select').value = 'available';
      updateStatusInfo('available');
      
      // Start periodic updates
      locationInterval = setInterval(() => {
        const lat = parseFloat(document.getElementById('d_lat').value);
        const lng = parseFloat(document.getElementById('d_lng').value);
        if (!isNaN(lat) && !isNaN(lng)) {
          fetch(`/order/drivers/${auth.profile.id}/gps`, {
            method: 'PUT',
            headers: headers(),
            body: JSON.stringify({longitude: lng, latitude: lat})
          }).then(() => log('📍 Location updated'));
        }
      }, 30000);
      
    } catch (e) {
      log('❌ Failed:', e.message);
      alert('Error: ' + e.message);
      isOnline = false;
    }
    
  } else {
    log('🔴 GOING OFFLINE...');
    
    try {
      if (locationInterval) {
        clearInterval(locationInterval);
        locationInterval = null;
      }
      
      const res = await fetch(`/driver/${auth.profile.id}/status`, {
        method: 'PATCH',
        headers: headers(),
        body: JSON.stringify({status: 'offline'})
      });
      
      if (!res.ok) throw new Error('Failed to update status');
      
      log('✅ NOW OFFLINE');
      
      // Sync status dropdown
      document.getElementById('status_select').value = 'offline';
      updateStatusInfo('offline');
      
    } catch (e) {
      log('❌ Failed:', e.message);
      alert('Error: ' + e.message);
    }
  }
  
  updateOnlineStatus();
}

function updateOnlineStatus() {
  const btn = document.getElementById('online_btn');
  const status = document.getElementById('driver_status');
  
  if (isOnline) {
    btn.textContent = '🔴 Go Offline';
    btn.className = 'online';
    status.innerHTML = '<span class="status-badge online">🟢 ONLINE</span>';
  } else {
    btn.textContent = '🟢 Go Online';
    btn.className = '';
    status.innerHTML = '<span class="status-badge offline">🔴 OFFLINE</span>';
  }
}

async function acceptDelivery(orderId) {
  if (!auth.profile?.id) {
    alert('No driver profile!');
    return;
  }
  
  log('✅ Accepting order', orderId);
  
  try {
    const r = await fetch(`/order/${orderId}/assign-driver`, {
      method: 'POST',
      headers: headers(),
      body: JSON.stringify({driver_id: auth.profile.id})
    });
    
    const j = await r.json();
    
    if (r.ok) {
      log('✅ DELIVERY ACCEPTED!');
      
      const cards = document.getElementById('d_deliveries').querySelectorAll('.card');
      cards.forEach(card => {
        if (card.textContent.includes('#' + orderId) || card.textContent.includes(orderId)) {
          card.style.opacity = '0.5';
          card.querySelector('button').disabled = true;
          card.querySelector('button').textContent = '✓ Accepted';
        }
      });
      
      // Reload status (should now be "busy")
      loadCurrentStatus();
      
      alert('Delivery accepted!');
    } else {
      alert('Error: ' + (j.message || 'Could not accept'));
      log('❌ Failed:', j.message);
    }
  } catch (e) {
    alert('Error: ' + e.message);
    log('❌ Error:', e.message);
  }
}
</script>
</body>
</html>