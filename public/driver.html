<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Driver - Tawssil Cockpit</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: #050a12;
      color: #f8fafc;
      --accent: #10b981;
      --accent-dark: #047857;
      --panel: #0f172a;
      --panel-soft: #111b2c;
      --muted: #94a3b8;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      min-height: 100vh;
      background: linear-gradient(180deg, #020617, #0f172a);
      color: #f8fafc;
    }
    .driver-shell {
      display: grid;
      grid-template-columns: 320px 1fr 360px;
      gap: 1rem;
      padding: 1.5rem;
      min-height: 100vh;
    }
    .driver-sidebar,
    .driver-log,
    .driver-main > .panel {
      background: var(--panel);
      border-radius: 24px;
      padding: 1.5rem;
      border: 1px solid rgba(255,255,255,0.08);
      box-shadow: 0 35px 60px rgba(0,0,0,0.45);
    }
    .driver-sidebar {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: #050a12;
    }
    .brand {
      font-size: 1.6rem;
      font-weight: 700;
      display: flex;
      justify-content: space-between;
      align-items: center;
      color: #f8fafc;
    }
    .brand span { font-size: 0.9rem; color: var(--accent); }
    .sidebar-card {
      background: var(--panel-soft);
      border-radius: 18px;
      padding: 1rem;
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
      border: 1px solid rgba(255,255,255,0.08);
    }
    .sidebar-card h2 { margin: 0; font-size: 1.1rem; color: #f8fafc; }
    input, select, button, textarea { font-family: inherit; }
    .sidebar-card input,
    .sidebar-card select {
      width: 100%;
      padding: 0.75rem;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.1);
      background: #0f172a;
      color: #f8fafc;
    }
    .sidebar-card button {
      border: none;
      border-radius: 12px;
      padding: 0.8rem;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 10px 20px rgba(16,185,129,0.35);
    }
    .status-pill {
      padding: 0.35rem 0.9rem;
      border-radius: 999px;
      background: rgba(16,185,129,0.2);
      color: var(--accent);
      font-weight: 600;
      font-size: 0.8rem;
    }
    .location-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
    }
    #online_btn {
      border-radius: 12px;
      border: none;
      padding: 0.85rem;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #fff;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 15px 25px rgba(16,185,129,0.35);
    }
    .capacity {
      border: 1px solid rgba(255,255,255,0.1);
      background: #111b2c;
    }
    .capacity-info {
      display: flex;
      flex-direction: column;
      gap: 0.65rem;
    }
    .capacity-bar {
      background: rgba(255,255,255,0.07);
      border-radius: 999px;
      overflow: hidden;
      height: 28px;
    }
    .capacity-fill {
      background: linear-gradient(90deg, var(--accent), var(--accent-dark));
      height: 100%;
      width: 0;
      color: #fff;
      font-size: 0.8rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .driver-main {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    .panel {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      background: var(--panel-soft);
      border: none;
    }
    .panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .panel-header h2 { margin: 0; font-size: 1.4rem; color: #f8fafc; }
    .panel-header button {
      border: none;
      border-radius: 12px;
      padding: 0.6rem 1.2rem;
      background: linear-gradient(135deg, var(--accent), var(--accent-dark));
      color: #fff;
      font-weight: 600;
      cursor: pointer;
    }
    .panel .empty { margin: 0; color: #a5b4fc; }
    .log-panel { background: #020617; }
    .log-panel h2 { color: #f8fafc; margin: 0 0 0.6rem; }
    .log-panel .log {
      background: transparent;
      border: none;
      color: #e2e8f0;
      font-size: 0.9rem;
      height: 100%;
    }
    .tabs {
      display: flex;
      gap: 0.6rem;
    }
    .tab {
      border: none;
      padding: 0.65rem 1.2rem;
      border-radius: 999px;
      background: rgba(255,255,255,0.06);
      color: #f8fafc;
      font-weight: 600;
      cursor: pointer;
    }
    .tab.active {
      background: var(--accent);
      color: #fff;
    }
    .tab-content {
      display: none;
      flex-direction: column;
      gap: 0.85rem;
    }
    .tab-content.active { display: flex; }
    #d_deliveries .card,
    #nearby_deliveries .card {
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.1);
      padding: 1rem;
      background: #111b2c;
      display: flex;
      flex-direction: column;
      gap: 0.4rem;
      color: #f8fafc;
    }
    #d_deliveries .card.highlight {
      border-color: var(--accent);
      box-shadow: 0 20px 30px rgba(16,185,129,0.25);
    }
    .tabs .badge {
      background: rgba(239, 68, 68, 0.2);
      color: #f87171;
      border-radius: 999px;
      padding: 0.15rem 0.7rem;
      font-size: 0.75rem;
    }
    @media (max-width: 1100px) {
      .driver-shell { grid-template-columns: 1fr; }
      .driver-log { order: -1; }
    }
</style>
</head>
<body>
  <div class="driver-shell">
    <aside class="driver-sidebar">
      <div class="brand">
        <strong>Driver Portal</strong>
        <span>Live</span>
      </div>
      <div class="sidebar-card">
        <h2>Connexion</h2>
        <input id="d_email" placeholder="Email" type="email" value="driver5@example.com">
        <input id="d_password" type="password" placeholder="Password" value="password123">
        <button onclick="driverLogin()">Login</button>
        <div id="login_status" class="status-badge" style="display:none"></div>
      </div>
      <div class="sidebar-card">
        <h2>Statut</h2>
        <select id="status_select" onchange="changeStatus()" disabled>
          <option value="available">Available</option>
          <option value="busy">Busy</option>
          <option value="offline">Offline</option>
          <option value="suspended">Suspended</option>
        </select>
        <div id="status_info"></div>
      </div>
      <div class="sidebar-card">
        <h2>Position</h2>
        <div class="location-grid">
          <input id="d_lat" placeholder="Latitude" value="36.75">
          <input id="d_lng" placeholder="Longitude" value="2.8">
        </div>
        <button id="online_btn" onclick="toggleOnline()" disabled>Go Online</button>
        <div id="driver_status"></div>
      </div>
      <div class="sidebar-card capacity" id="capacity_display" style="display:none">
        <h2>Capacit√©</h2>
        <div class="capacity-info">
          <div style="display:flex;justify-content:space-between;align-items:center;">
            <strong>Active Orders</strong>
            <span id="capacity_text">0 / 5</span>
          </div>
          <div class="capacity-bar">
            <div id="capacity_fill" class="capacity-fill">0%</div>
          </div>
          <div style="font-size:0.85rem;color:#475569;">
            <span id="capacity_message">Ready to accept orders</span>
          </div>
        </div>
      </div>
    </aside>
    <main class="driver-main">
      <section class="panel" id="active_orders_section" style="display:none">
        <div class="panel-header">
          <h2>My Active Orders</h2>
          <button onclick="loadActiveOrders()">Refresh</button>
        </div>
        <div id="active_orders_list">
          <div class="empty">No active orders</div>
        </div>
      </section>
      <section class="panel" id="deliveries_section" style="display:none">
        <div class="panel-header">
          <h2>Available Deliveries</h2>
        </div>
        <div class="tabs">
          <button class="tab active" onclick="switchTab('available')">
            Available <span class="badge" id="available_count">0</span>
          </button>
          <button class="tab" onclick="switchTab('nearby')">Nearby</button>
        </div>
        <div id="tab_available" class="tab-content active">
          <div id="d_deliveries">
            <div class="empty">No deliveries available. Go online to receive requests!</div>
          </div>
        </div>
        <div id="tab_nearby" class="tab-content">
          <button onclick="loadNearbyOrders()">Refresh Nearby</button>
          <div id="nearby_deliveries">
            <div class="empty">Click refresh to load nearby orders</div>
          </div>
        </div>
      </section>
    </main>
    <aside class="driver-log">
      <section class="panel">
        <h2>Activity Log</h2>
        <pre id="d_log" class="log">Waiting for connection...</pre>
        <div id="driver_notifications"></div>
      </section>
    </aside>
  </div>
  <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
  <script>
let socket = null;
let auth = {role: null, token: null, user: null, profile: null};
let isOnline = false;
let locationInterval = null;
let activeOrders = [];
let maxCapacity = 5;

async function apiFetch(url, options = {}) {
  const token = auth.token || '';
  const headers = {
    'Content-Type': 'application/json',
    ...(options.headers || {}),
    ...(token ? { Authorization: `Bearer ${token}` } : {})
  };
  const response = await fetch(url, { ...options, headers });
  return response;
}

function log(...msg) {
  const e = document.getElementById('d_log');
  e.textContent = `[${new Date().toLocaleTimeString()}] ${msg.join(' ')}\n` + e.textContent;
}

function switchTab(tabName) {
  document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
  
  document.querySelector(`[onclick="switchTab('${tabName}')"]`).classList.add('active');
  document.getElementById(`tab_${tabName}`).classList.add('active');
}

function updateCapacity() {
  const count = activeOrders.length;
  const percentage = (count / maxCapacity) * 100;
  
  document.getElementById('capacity_text').textContent = `${count} / ${maxCapacity}`;
  document.getElementById('capacity_fill').style.width = `${percentage}%`;
  document.getElementById('capacity_fill').textContent = `${Math.round(percentage)}%`;
  document.getElementById('active_count').textContent = count;
  
  const fill = document.getElementById('capacity_fill');
  if (count >= maxCapacity) {
    fill.classList.add('full');
    document.getElementById('capacity_message').textContent = '‚ö†Ô∏è At maximum capacity';
  } else {
    fill.classList.remove('full');
    const remaining = maxCapacity - count;
    document.getElementById('capacity_message').textContent = `Can accept ${remaining} more order${remaining !== 1 ? 's' : ''}`;
  }
}

function initSocket() {
  if (socket) {
    log('‚ö†Ô∏è Socket already exists');
    return;
  }
  
  log('üîå Connecting socket...');
  
  socket = io(location.origin, {
    auth: {token: auth.token}
  });
  
  socket.on('connect', () => {
    log('‚úÖ Socket connected! ID:', socket.id);
    log('üë§ Driver Profile ID:', auth.profile?.id);
    log('üì° Listening for deliveries...');
    document.getElementById('online_btn').disabled = false;
    
    if (auth.profile?.id) {
      socket.emit('join', `driver:${auth.profile.id}`);
      socket.emit('join', 'driver');
      socket.emit('join', 'drivers');
      log(`üìç Joined rooms: driver:${auth.profile.id}, driver, drivers`);
    }
    
    loadActiveOrders();
  });
  
  socket.on('connect_error', (error) => {
    log('‚ùå Connection error:', error.message);
  });
  
  socket.on('order_broadcast', data => {
    log('üì° BROADCAST: New order available somewhere');
    const availableCount = document.getElementById('available_count');
    availableCount.textContent = parseInt(availableCount.textContent || 0) + 1;
  });
  
  socket.on('new_delivery', data => {
    log('üö® NEW_DELIVERY: Order assigned to you!');
    log('Data:', JSON.stringify(data));
    handleNewDelivery(data);
  });
  
  socket.on('notification', data => {
    log('üì¨ Notification:', JSON.stringify(data));
    
    if (data.type === 'new_delivery' || data.orderId) {
      handleNewDelivery(data);
    } else if (data.type === 'delivery_complete') {
      log(`‚úÖ Delivery completed! ${data.active_orders_count} order(s) remaining`);
      loadActiveOrders();
      updateCapacity();
    } else if (data.type === 'config_update') {
      log(`‚öôÔ∏è Config updated: ${data.message}`);
      maxCapacity = data.max_orders_per_driver || 5;
      updateCapacity();
    }
  });
  
  socket.on('disconnect', () => {
    log('‚ùå Disconnected');
  });
  
  socket.onAny((event, ...args) => {
    log(`üîî Event: ${event}`, JSON.stringify(args));
  });
}

function handleNewDelivery(data) {
  log('üö® Processing new delivery...');
  log('Order:', data.orderNumber, '| Distance:', data.distance, 'km');
  
  const box = document.getElementById('d_deliveries');
  if (box.querySelector('.empty')) box.innerHTML = '';
  
  const div = document.createElement('div');
  div.className = 'card highlight';
  div.id = `delivery_${data.orderId}`;
  
  // ‚úÖ Check if driver can accept more orders
  const canAccept = activeOrders.length < maxCapacity;
  const buttonDisabled = canAccept ? '' : 'disabled style="opacity:0.5;cursor:not-allowed"';
  const buttonText = canAccept ? '‚úÖ Accept Delivery' : '‚ö†Ô∏è At Capacity';
  
  div.innerHTML = `
    <div class="delivery-badge">NEW!</div>
    <strong class="order-number">Order #${data.orderNumber || data.orderId}</strong>
    <div class="location-info">
      <strong>üìç Distance:</strong> ${data.distance || '?'} km<br>
      <strong>üí∞ Delivery Fee:</strong> ${data.fee || 0} DA<br>
      <strong>üìç Address:</strong> ${data.deliveryAddress || 'Not specified'}<br>
      <strong>üç¥ Restaurant:</strong> ${data.restaurant || 'Restaurant'}
    </div>
    <button class="success" onclick="acceptDelivery('${data.orderId}')" ${buttonDisabled}>${buttonText}</button>
  `;
  box.prepend(div);
  
  // Update available count
  const availableCount = document.getElementById('available_count');
  availableCount.textContent = box.querySelectorAll('.card:not(.capacity-warning)').length;
  
  if ('Notification' in window && Notification.permission === 'granted') {
    new Notification('New Delivery Available! üö®', {
      body: `Order #${data.orderNumber} - ${data.distance} km away - ${data.fee} DA`,
      icon: 'üõµ',
      requireInteraction: true
    });
  }
  
  playNotificationSound();
}
async function loadActiveOrders() {
  if (!auth.profile?.id) return;
  
  log('üì° Loading active orders...');
  
  try {
    const res = await apiFetch('/driver/active-orders');
    const data = await res.json();
    
    if (res.ok) {
      activeOrders = data.data?.active_orders || [];
      maxCapacity = data.data?.capacity || 5;
      
      renderActiveOrders();
      updateCapacity();
      
      document.getElementById('active_orders_section').style.display = 'block';
      document.getElementById('capacity_display').style.display = 'block';
      
      log(`‚úÖ Loaded ${activeOrders.length} active orders`);
    } else {
      log('‚ùå Failed to load active orders:', data.message);
    }
  } catch (error) {
    log('‚ùå Error loading active orders:', error.message);
  }
}

function renderActiveOrders() {
  const box = document.getElementById('active_orders_list');
  
  if (activeOrders.length === 0) {
    box.innerHTML = '<div class="empty">No active orders</div>';
    return;
  }
  
  box.innerHTML = '';
  
  activeOrders.forEach((order, index) => {
    const div = document.createElement('div');
    div.className = 'card active-order';
    div.setAttribute('data-order', order.id);
    
    // ‚úÖ Dynamic status badge color
    let statusBadgeClass = order.status;
    if (order.status === 'arrived') statusBadgeClass = 'delivering';
    
    div.innerHTML = `
      <strong class="order-number">#${order.order_number}</strong>
      <span class="status-badge ${statusBadgeClass}">${order.status.toUpperCase()}</span>
      
      <div class="order-route">
        <div class="route-step ${['assigned', 'arrived'].includes(order.status) ? 'current' : ''}">
          <div class="route-step-icon">üç¥</div>
          <div>
            <strong>${order.restaurant.name}</strong><br>
            <small style="color:#666">${order.restaurant.address}</small>
          </div>
        </div>
        <div class="route-step ${order.status === 'delivering' ? 'current' : ''}">
          <div class="route-step-icon">üìç</div>
          <div>
            <strong>Delivery Address</strong><br>
            <small style="color:#666">${order.delivery_address}</small>
          </div>
        </div>
      </div>
      
      <div class="location-info">
        <strong>üí∞ Amount:</strong> ${order.total_amount} DA<br>
        <strong>üìû Client:</strong> Contact via app<br>
        <strong>‚è∞ Assigned:</strong> ${new Date(order.assigned_at).toLocaleTimeString()}
      </div>
      
      <div class="order-actions">
        <button onclick="showRoutePreview('${order.id}')">üîé Distances</button>
        
        ${order.status === 'assigned' ? `
          <button onclick="markArrived('${order.id}')">üìç Arrived at Restaurant</button>
        ` : ''}
        
        ${order.status === 'arrived' ? `
          <button class="success" onclick="startDelivery('${order.id}')">üöÄ Start Delivery</button>
        ` : ''}
        
        ${order.status === 'delivering' ? `
          <button class="success" onclick="completeDelivery('${order.id}')">‚úÖ Complete Delivery</button>
        ` : ''}
        
        <button class="danger" onclick="cancelOrder('${order.id}')">‚ùå Cancel</button>
      </div>
      <div class='route-preview'></div>
    `;
    box.appendChild(div);
  });
}
async function loadNearbyOrders() {
  if (!auth.profile?.id) return;
  
  log('üìç Loading nearby orders...');
  
  try {
    const res = await apiFetch('/order/nearby?radius=5000&pageSize=20');
    const data = await res.json();
    
    if (res.ok) {
      const orders = data.data || [];
      const box = document.getElementById('nearby_deliveries');
      
      if (orders.length === 0) {
        box.innerHTML = '<div class="empty">No nearby orders found</div>';
        return;
      }
      
      box.innerHTML = '';
      
      orders.forEach(order => {
        const div = document.createElement('div');
        div.className = 'card';
        div.innerHTML = `
          <strong class="order-number">Order #${order.order_number}</strong>
          <div class="location-info">
            <strong>üìç Distance:</strong> ${order.distance_km} km<br>
            <strong>üí∞ Fee:</strong> ${order.delivery_fee} DA<br>
            <strong>üìç Address:</strong> ${order.delivery_address}<br>
            <strong>üç¥ Restaurant:</strong> ${order.restaurant.name}
          </div>
          <button class="success" onclick="acceptDelivery('${order.id}')">‚úÖ Accept</button>
        `;
        box.appendChild(div);
      });
      
      log(`‚úÖ Loaded ${orders.length} nearby orders`);
    }
  } catch (error) {
    log('‚ùå Error loading nearby orders:', error.message);
  }
}

async function driverLogin() {
  const email = document.getElementById('d_email').value;
  const password = document.getElementById('d_password').value;
  
  if (!email || !password) {
    alert('Please enter email and password');
    return;
  }
  
  log('üîê Logging in...');
  
  try {
    const r = await fetch('/auth/login', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({email, password, type:'driver'})
    });
    
    const j = await r.json();
    
    if (r.ok) {
      auth = {role: 'driver', token: j.access_token, user: j.user, profile: j.profile};
      
      document.getElementById('login_status').style.display = 'inline-block';
      document.getElementById('login_status').textContent = '‚úÖ ' + (j.profile?.first_name || j.user.email);
      
      log('‚úÖ LOGGED IN');
      log('Driver Profile ID:', j.profile?.id);
      
      if (!j.profile?.id) {
        alert('‚ö†Ô∏è No driver profile found!');
        document.getElementById('online_btn').disabled = true;
        return;
      }
      
      initSocket();
      document.getElementById('status_select').disabled = false;
      document.getElementById('deliveries_section').style.display = 'block';
      loadCurrentStatus();
      
      if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
      }
    } else {
      alert('Login failed: ' + (j.message || 'Unknown'));
      log('‚ùå Failed:', j.message);
    }
  } catch (e) {
    alert('Error: ' + e.message);
    log('‚ùå Error:', e.message);
  }
}

async function changeStatus() {
  if (!auth.profile?.id) {
    alert('Please login first');
    return;
  }
  
  const newStatus = document.getElementById('status_select').value;
  
  if (newStatus === 'busy' && activeOrders.length === 0) {
    alert('Cannot set Busy manually. System sets it when you accept deliveries.');
    loadCurrentStatus();
    return;
  }
  
  if ((newStatus === 'offline' || newStatus === 'available') && activeOrders.length > 0) {
    alert('Cannot change status while having active deliveries!');
    loadCurrentStatus();
    return;
  }
  
  log('üîÑ Changing status to:', newStatus);
  
  try {
    const res = await apiFetch(`/driver/status`, {
      method: 'PATCH',
      body: JSON.stringify({ status: newStatus })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      log('‚úÖ Status updated to:', newStatus);
      updateStatusInfo(newStatus);
      isOnline = (newStatus === 'available');
      updateOnlineStatus();
    } else {
      alert('Error: ' + (data.message || 'Failed to update status'));
      log('‚ùå Failed:', data.message);
      loadCurrentStatus();
    }
  } catch (e) {
    alert('Error: ' + e.message);
    log('‚ùå Error:', e.message);
    loadCurrentStatus();
  }
}

async function loadCurrentStatus() {
  if (!auth.profile?.id) return;
  
  try {
    const res = await apiFetch(`/driver/${auth.profile.id}`);
    const data = await res.json();
    
    if (res.ok && data.data) {
      const driver = data.data;
      document.getElementById('status_select').value = driver.status;
      updateStatusInfo(driver.status);
      auth.profile.status = driver.status;
      isOnline = (driver.status === 'available');
      updateOnlineStatus();
    }
  } catch (e) {
    log('‚ö†Ô∏è Failed to load status:', e.message);
  }
}

function updateStatusInfo(status) {
  const info = document.getElementById('status_info');
  const messages = {
    available: '‚úÖ You are available and will receive delivery requests',
    busy: '‚ö†Ô∏è You are busy with active deliveries',
    offline: 'üî¥ You are offline and will not receive requests',
    suspended: '‚õî Your account is suspended. Contact support.'
  };
  info.textContent = messages[status] || '';
  info.style.color = status === 'suspended' ? '#dc2626' : '#666';
}

async function toggleOnline() {
  if (!auth.profile?.id) {
    alert('No driver profile!');
    return;
  }

  const lat = parseFloat(document.getElementById('d_lat').value);
  const lng = parseFloat(document.getElementById('d_lng').value);

  if (isNaN(lat) || isNaN(lng)) {
    alert('Invalid coordinates');
    return;
  }

  isOnline = !isOnline;

  if (isOnline) {
    log('üü¢ GOING ONLINE...');

    try {
      const statusRes = await apiFetch(`/driver/status`, { 
        method: 'PATCH', 
        body: JSON.stringify({ status: 'available' }) 
      });

      if (!statusRes.ok) throw new Error('Failed to update status');

      const locationRes = await apiFetch(`/order/drivers/${auth.profile.id}/gps`, {
        method: 'PUT',
        body: JSON.stringify({ longitude: lng, latitude: lat })
      });
      if (!locationRes.ok) throw new Error('Failed to update location');

      log('‚úÖ NOW ONLINE');
      log(`Location: (${lat}, ${lng})`);

      document.getElementById('status_select').value = 'available';
      updateStatusInfo('available');

      locationInterval = setInterval(() => {
        const lat = parseFloat(document.getElementById('d_lat').value);
        const lng = parseFloat(document.getElementById('d_lng').value);
        if (!isNaN(lat) && !isNaN(lng)) {
          apiFetch(`/order/drivers/${auth.profile.id}/gps`, {
            method: 'PUT',
            body: JSON.stringify({ longitude: lng, latitude: lat })
          }).then(() => log('üìç Location updated'));
        }
      }, 30000);

    } catch (e) {
      log('‚ùå Failed:', e.message);
      alert('Error: ' + e.message);
      isOnline = false;
    }

  } else {
    log('üî¥ GOING OFFLINE...');

    try {
      if (locationInterval) {
        clearInterval(locationInterval);
        locationInterval = null;
      }

      const res = await apiFetch(`/driver/status`, { 
        method: 'PATCH', 
        body: JSON.stringify({ status: 'offline' }) 
      });

      if (!res.ok) throw new Error('Failed to update status');

      log('‚úÖ NOW OFFLINE');

      document.getElementById('status_select').value = 'offline';
      updateStatusInfo('offline');

    } catch (e) {
      log('‚ùå Failed:', e.message);
      alert('Error: ' + e.message);
    }
  }

  updateOnlineStatus();
}

function updateOnlineStatus() {
  const btn = document.getElementById('online_btn');
  const status = document.getElementById('driver_status');
  
  if (isOnline) {
    btn.textContent = 'üî¥ Go Offline';
    btn.className = 'online';
    status.innerHTML = '<span class="status-badge online">üü¢ ONLINE</span>';
  } else {
    btn.textContent = 'üü¢ Go Online';
    btn.className = '';
    status.innerHTML = '<span class="status-badge offline">üî¥ OFFLINE</span>';
  }
}
// ‚úÖ NEW: Update available delivery buttons based on capacity
function updateAvailableDeliveryButtons() {
  const canAcceptMore = activeOrders.length < maxCapacity;
  
  // Get all accept buttons in available deliveries
  const acceptButtons = document.querySelectorAll('#d_deliveries .card button.success');
  
  acceptButtons.forEach(button => {
    if (canAcceptMore) {
      button.disabled = false;
      button.style.opacity = '1';
      button.style.cursor = 'pointer';
    } else {
      button.disabled = true;
      button.style.opacity = '0.5';
      button.style.cursor = 'not-allowed';
      button.textContent = '‚ö†Ô∏è At Capacity';
    }
  });
  
  // Show/hide message
  if (!canAcceptMore) {
    const deliveriesBox = document.getElementById('d_deliveries');
    if (!deliveriesBox.querySelector('.capacity-warning')) {
      const warning = document.createElement('div');
      warning.className = 'card capacity-warning';
      warning.style.background = '#fef3c7';
      warning.style.borderLeft = '4px solid #f59e0b';
      warning.innerHTML = `
        <strong>‚ö†Ô∏è Maximum Capacity Reached</strong><br>
        <span style="font-size:13px">Complete some deliveries to accept more orders (${activeOrders.length}/${maxCapacity})</span>
      `;
      deliveriesBox.prepend(warning);
    }
  } else {
    // Remove warning if it exists
    const warning = document.querySelector('.capacity-warning');
    if (warning) warning.remove();
  }
}
async function acceptDelivery(orderId) {
  if (!auth.profile?.id) {
    alert('No driver profile!');
    return;
  }
  
  // Check capacity
  if (activeOrders.length >= maxCapacity) {
    alert(`‚ö†Ô∏è You are at maximum capacity (${maxCapacity} orders). Please complete some deliveries first.`);
    return;
  }
  
  log('‚úÖ Accepting order', orderId);
  
  try {
    const r = await apiFetch(`/order/${orderId}/assign-driver`, {
      method: 'POST',
      body: JSON.stringify({ driver_id: auth.profile.id })
    });
    
    const j = await r.json();
    
    if (r.ok) {
      log('‚úÖ DELIVERY ACCEPTED!');
      
      // Remove from available list
      const card = document.getElementById(`delivery_${orderId}`);
      if (card) card.remove();
      
      // Update available count
      const availableCount = document.getElementById('available_count');
      const remaining = document.querySelectorAll('#d_deliveries .card:not(.capacity-warning)').length;
      availableCount.textContent = remaining;
      
      // ‚úÖ Reload active orders
      await loadActiveOrders();
      
      // ‚úÖ NEW: Update available delivery buttons based on new capacity
      updateAvailableDeliveryButtons();
      
      alert('Delivery accepted! Check your active orders.');
    } else {
      alert('Error: ' + (j.message || 'Could not accept'));
      log('‚ùå Failed:', j.message);
    }
  } catch (e) {
    alert('Error: ' + e.message);
    log('‚ùå Error:', e.message);
  }
}
async function startDelivery(orderId) {
  log('üöÄ Starting delivery:', orderId);
  
  try {
    const res = await apiFetch(`/order/${orderId}/start-delivery`, {
      method: 'POST'
    });
    
    if (res.ok) {
      log('‚úÖ Delivery started');
      await loadActiveOrders();
    } else {
      const data = await res.json();
      alert('Error: ' + (data.message || 'Failed to start delivery'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
    log('‚ùå Error:', error.message);
  }
}

async function completeDelivery(orderId) {
  log('‚úÖ Completing delivery:', orderId);
  
  try {
    const res = await apiFetch(`/order/${orderId}/complete-delivery`, {
      method: 'POST'
    });
    
    if (res.ok) {
      log('‚úÖ Delivery completed!');
      await loadActiveOrders();
      
      // ‚úÖ NEW: Re-enable available delivery buttons
      updateAvailableDeliveryButtons();
      
      alert('Delivery completed successfully! üéâ');
    } else {
      const data = await res.json();
      alert('Error: ' + (data.message || 'Failed to complete delivery'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
    log('‚ùå Error:', error.message);
  }
}
// ‚úÖ FIXED: Updated cancelOrder function for driver.html
// Replace the existing cancelOrder function with this one

async function cancelOrder(orderId) {
  const reason = prompt('‚ö†Ô∏è Why are you canceling this order?\n\nPlease provide a detailed reason (minimum 10 characters):');
  
  if (!reason || reason.trim().length < 10) {
    alert('Cancellation reason must be at least 10 characters');
    return;
  }
  
  if (!confirm(`Are you sure you want to cancel this order?\n\nReason: ${reason}\n\nNote: Multiple cancellations may affect your account.`)) {
    return;
  }
  
  log('‚ùå Canceling order:', orderId);
  
  try {
    const res = await apiFetch(`/order/${orderId}/driver-cancel`, {
      method: 'POST',
      body: JSON.stringify({ reason: reason.trim() })
    });
    
    const data = await res.json();
    
    if (res.ok) {
      log('‚úÖ Order cancelled successfully');
      
      // Show warning if exists
      if (data.warning) {
        alert('‚ö†Ô∏è ' + data.warning);
      }
      
      // ‚úÖ FIX: Force reload active orders immediately
      await loadActiveOrders();
      
      // ‚úÖ FIX: Update capacity display
      updateCapacity();
      updateAvailableDeliveryButtons();

      // Show success message
      alert('Order cancelled successfully. The system will find another driver.');
      
      log(`üìä Updated active orders: ${activeOrders.length} remaining`);
    } else {
      alert('Error: ' + (data.message || 'Failed to cancel order'));
      log('‚ùå Failed:', data.message);
    }
  } catch (error) {
    alert('Error: ' + error.message);
    log('‚ùå Error:', error.message);
  }
}
// Listen for server warnings about cancellations
socket.on('driver:cancellation_threshold', (payload) => {
  const box = document.getElementById('driver_notifications');
  if (box) {
    const note = document.createElement('div');
    note.className = 'order warning';
    note.style.border = '1px solid #f59e0b';
    note.style.background = '#fff7ed';
    note.style.padding = '10px';
    note.style.borderRadius = '8px';
    note.style.margin = '6px 0';
    note.innerHTML = `<strong>‚ö†Ô∏è Attention:</strong> ${payload.message} (annulations: ${payload.cancellation_count})`;
    box.prepend(note);
    playNotificationSound();
  }
});

function playNotificationSound() {
  try {
    const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBSqGzvLRfzMGH2S77eeXQAoRVq/n7bJiGgU+lNrywn0pBSh+zPDajEULFlqx6P+oUxMJS6Hh8LdgGgU7k9r0xnktBSV7zPDajUMLFlqx6PCkWBMKTaPi8LJeGgU6ktjzx3ktBSR6y+/fjEULFlqw5/CmWhMKTqPl8bhgGQU8k9j0x3ktBSR6y+/fjEQLFVqx6O+pWxMKT6Pm8rxfGgU9lNr0xnksBS17y+/fjEQKFVmw6PCmWhMKT6Pl8bdgGQU9lNn0xnktBSV7y+/gjEQLFVmw6PKlWhIKTqPl8bdgGQU9lNn0xnktBSV7yu/gjEQLFVmw6O+oWxMKTqPi8LZgGgU7k9n0xngtBSV8y+/gjEURFViv6PCmWhMKTaPh8LZhGgU7k9j0xnktBSZ8yu/fjEURFViv5/CmWhMKTqLi8LdeGgU7k9j0xnktBSZ7yu/fjEQRFVmv5+6nWRMKT6Lk8bdeGgU+k9j0xnktBSZ7yu/fjEQRFViv5+6mWhMKT6Lk8bdeGgU+k9j0xnktBSZ7yu/fjEQRFVmv5+6lWhMKTqHj8rdcGQU9k9j0xnktBSZ8y+/gjEQRFViv5+6lWhMKTqDk8bdeGgU9k9n0xngtBSZ7yu/fjEQRFVmw5+6nWhMKT6Hj8rdcGQU9k9j0xngtBSZ7yu/gjEQQFVmv5+6nWhMKT6Hj8rdcGQU9k9j0xnktBSZ7yu/gjEQRFVmv5+6mWhMKTqHi8bdcGgU9k9j0xnktBSZ7yu/fjEQRFViv6O6mWhMKTqHi8bdcGgU9k9j0xnktBSR7yu/fjEQRFVmv6O6nWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/fjEQRFVmv5+6mWhMKTqHi8bdeGgU9k9j0xnktBSZ7yu/f');
    audio.volume = 0.5;
    audio.play().catch(e => console.log('Audio play failed:', e));
  } catch (e) {
    console.log('Audio notification failed:', e);
  }
}

async function markArrived(orderId) {
  log('üìç Marking arrival at restaurant:', orderId);
  
  try {
    const res = await apiFetch(`/order/${orderId}/arrived`, {
      method: 'POST'
    });
    
    if (res.ok) {
      log('‚úÖ Marked as arrived at restaurant');
      await loadActiveOrders();
      
      // Show route preview
      const orderCard = document.querySelector(`[data-order="${orderId}"]`);
      if (orderCard) {
        const previewDiv = orderCard.querySelector('.route-preview');
        if (previewDiv) {
          previewDiv.innerHTML = '<div style="color:#10b981;font-size:13px;padding:10px;background:#f0fdf4;border-radius:6px;margin-top:10px">‚úÖ Arrived at restaurant. Waiting for order pickup...</div>';
        }
      }
    } else {
      const data = await res.json();
      alert('Error: ' + (data.message || 'Failed to mark arrival'));
    }
  } catch (error) {
    alert('Error: ' + error.message);
    log('‚ùå Error:', error.message);
  }
}
</script>
</body>
</html>
